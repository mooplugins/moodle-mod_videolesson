{"version":3,"file":"setup_wizard.min.js","sources":["../src/setup_wizard.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Setup Wizard functionality for videolesson plugin\n * UI enhancements only - state management is handled server-side via forms\n *\n * @module     mod_videolesson/setup_wizard\n * @copyright  2022-2026 BitKea Technologies LLP\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport * as Toast from 'core/toast';\nimport {get_string as getString} from 'core/str';\n\n/**\n * Helper function to get element by ID\n *\n * @param {string} id Element ID\n * @returns {HTMLElement|null}\n */\nconst getElement = (id) => {\n    return document.getElementById(id);\n};\n\n/**\n * Helper function to get elements by selector\n *\n * @param {string} selector CSS selector\n * @returns {NodeList}\n */\nconst getElements = (selector) => {\n    return document.querySelectorAll(selector);\n};\n\n/**\n * Initialize the setup wizard\n * Only handles UI enhancements - form submissions handle navigation\n *\n * @param {number} initialStep The initial step to show\n */\nexport const init = (initialStep = 1) => {\n    // Show the correct step on page load (server-side already handles this, but ensure it's visible)\n    getElements('.step-content').forEach(el => {\n        el.style.display = 'none';\n    });\n    const currentStepEl = getElement(`step-${initialStep}-content`);\n    if (currentStepEl) {\n        currentStepEl.style.display = '';\n    }\n\n    // Update step indicators\n    getElements('.step-indicator').forEach(el => {\n        el.classList.remove('current');\n    });\n    const currentIndicator = document.querySelector(`.step-indicator[data-step=\"${initialStep}\"]`);\n    if (currentIndicator) {\n        currentIndicator.classList.add('current');\n    }\n\n    // Step 1: Hosting selection UI enhancements (card selection visual feedback)\n    const hostingCards = getElements('.hosting-option-card');\n    const hostingRadios = getElements('input[name=\"hosting-type\"]');\n\n    // Ensure the checked radio's card is visually selected on page load\n    const checkedRadio = document.querySelector('input[name=\"hosting-type\"]:checked');\n    if (checkedRadio) {\n        const checkedCard = checkedRadio.closest('.hosting-option-card');\n        if (checkedCard) {\n            const cardElement = checkedCard.querySelector('.hosting-card');\n            if (cardElement) {\n                cardElement.classList.add('selected');\n            }\n        }\n    }\n\n    // Handle card clicks for visual feedback\n    hostingCards.forEach(card => {\n        card.addEventListener('click', function() {\n            const radio = this.querySelector('input[type=\"radio\"]');\n\n            // Unselect all cards\n            hostingCards.forEach(c => {\n                const cardElement = c.querySelector('.hosting-card');\n                if (cardElement) {\n                    cardElement.classList.remove('selected');\n                }\n            });\n\n            // Select clicked card\n            const clickedCard = this.querySelector('.hosting-card');\n            if (clickedCard) {\n                clickedCard.classList.add('selected');\n            }\n            if (radio) {\n                radio.checked = true;\n            }\n        });\n    });\n\n    // Also handle radio button clicks directly\n    hostingRadios.forEach(radio => {\n        radio.addEventListener('change', function() {\n            const card = this.closest('.hosting-option-card');\n            if (card) {\n                // Trigger card click for visual feedback\n                const cardElement = card.querySelector('.hosting-card');\n                if (cardElement) {\n                    // Unselect all cards\n                    hostingCards.forEach(c => {\n                        const cardEl = c.querySelector('.hosting-card');\n                        if (cardEl) {\n                            cardEl.classList.remove('selected');\n                        }\n                    });\n                    // Select this card\n                    cardElement.classList.add('selected');\n                }\n            }\n        });\n    });\n\n    // Step 2: AWS Settings Form validation (enable/disable validate button)\n    const step2ValidateBtn = getElement('step2-validate-btn');\n    if (step2ValidateBtn) {\n        // Enable/disable validate button based on form fields\n        const checkFormValidity = () => {\n            const apiKey = getElement('aws-api-key')?.value.trim();\n            const apiSecret = getElement('aws-api-secret')?.value.trim();\n            const s3InputBucket = getElement('aws-s3-input-bucket')?.value.trim();\n            const s3OutputBucket = getElement('aws-s3-output-bucket')?.value.trim();\n\n            // Enable button if all required fields are filled\n            if (apiKey && apiSecret && s3InputBucket && s3OutputBucket) {\n                step2ValidateBtn.disabled = false;\n            } else {\n                step2ValidateBtn.disabled = true;\n            }\n        };\n\n        // Add event listeners to form fields\n        const formFields = ['aws-api-key', 'aws-api-secret', 'aws-s3-input-bucket', 'aws-s3-output-bucket'];\n        formFields.forEach(fieldId => {\n            const field = getElement(fieldId);\n            if (field) {\n                field.addEventListener('input', checkFormValidity);\n                field.addEventListener('change', checkFormValidity);\n            }\n        });\n\n        // Check initial state\n        checkFormValidity();\n\n        // Handle form submission - show loading state for AWS validation\n        const awsForm = document.getElementById('aws-settings-form');\n        if (awsForm && step2ValidateBtn) {\n            awsForm.addEventListener('submit', function() {\n                // Show loading state - delay slightly to allow form submission to proceed\n                setTimeout(() => {\n                    step2ValidateBtn.disabled = true;\n                    // Store original HTML if not already stored\n                    if (!step2ValidateBtn.dataset.originalHtml) {\n                        step2ValidateBtn.dataset.originalHtml = step2ValidateBtn.innerHTML;\n                    }\n                    // Extract text content (excluding icon)\n                    const textNodes = Array.from(step2ValidateBtn.childNodes)\n                        .filter(node => node.nodeType === Node.TEXT_NODE)\n                        .map(node => node.textContent.trim())\n                        .join(' ');\n                    const buttonText = textNodes || 'Validating...';\n                    // Add spinner before the icon\n                    const spinnerHTML = '<span class=\"spinner-border spinner-border-sm mr-2\" ' +\n                        'role=\"status\" aria-hidden=\"true\"></span>';\n                    step2ValidateBtn.innerHTML = spinnerHTML +\n                        '<i class=\"fa fa-check-circle\"></i> ' + buttonText;\n                }, 10);\n            });\n        }\n    }\n\n    // Step 2 Hosted: Show/hide existing license field based on checkbox\n    const hasExistingLicenseCheckbox = getElement('has-existing-license');\n    const existingLicenseField = getElement('existing-license-field');\n    const existingLicenseKeyInput = getElement('existing-license-key');\n    const activateBtn = getElement('activate-btn');\n\n    if (hasExistingLicenseCheckbox && existingLicenseField) {\n        // Store original button HTML immediately (before any modifications)\n        if (activateBtn && !activateBtn.dataset.originalHtml) {\n            activateBtn.dataset.originalHtml = activateBtn.innerHTML;\n        }\n\n        // Handle checkbox change\n        hasExistingLicenseCheckbox.addEventListener('change', function() {\n            // Don't modify button if it's in loading state\n            if (activateBtn && activateBtn.disabled) {\n                return;\n            }\n\n            if (this.checked) {\n                existingLicenseField.style.display = 'block';\n                if (existingLicenseKeyInput) {\n                    existingLicenseKeyInput.focus();\n                }\n                // Change button text to \"Activate\" - use original HTML to preserve structure\n                if (activateBtn && activateBtn.dataset.originalHtml) {\n                    const originalHTML = activateBtn.dataset.originalHtml;\n                    // Extract icon and replace text with \"Activate\"\n                    const iconMatch = originalHTML.match(/<i[^>]*>.*?<\\/i>/);\n                    const icon = iconMatch ? iconMatch[0] : '<i class=\"fa fa-rocket\"></i>';\n                    activateBtn.innerHTML = icon + ' Activate';\n                }\n            } else {\n                existingLicenseField.style.display = 'none';\n                if (existingLicenseKeyInput) {\n                    existingLicenseKeyInput.value = '';\n                }\n                // Restore original button text\n                if (activateBtn && activateBtn.dataset.originalHtml) {\n                    activateBtn.innerHTML = activateBtn.dataset.originalHtml;\n                }\n            }\n        });\n\n        // Handle form submission - validate license key if checkbox is checked and show loading\n        const form = document.getElementById('step2-hosted-form');\n        if (form && activateBtn) {\n            form.addEventListener('submit', function(e) {\n                const action = activateBtn.getAttribute('value');\n                if (action === 'activate_free_hosting') {\n                    // Validate license key if checkbox is checked\n                    if (hasExistingLicenseCheckbox.checked) {\n                        const licenseKey = existingLicenseKeyInput?.value.trim();\n                        if (!licenseKey) {\n                            e.preventDefault();\n                            getString('setup:step2:hosted:existing:license:key:required', 'mod_videolesson').then((message) => {\n                                Toast.add(message, {type: 'error'});\n                            });\n                            if (existingLicenseKeyInput) {\n                                existingLicenseKeyInput.focus();\n                            }\n                            return false;\n                        }\n                    }\n\n                    // Show loading state - delay slightly to allow form submission to proceed\n                    setTimeout(() => {\n                        activateBtn.disabled = true;\n                        // Store original HTML if not already stored\n                        if (!activateBtn.dataset.originalHtml) {\n                            activateBtn.dataset.originalHtml = activateBtn.innerHTML;\n                        }\n                        // Extract text content (excluding icon)\n                        const textNodes = Array.from(activateBtn.childNodes)\n                            .filter(node => node.nodeType === Node.TEXT_NODE)\n                            .map(node => node.textContent.trim())\n                            .join(' ');\n                        const buttonText = textNodes || 'Activating...';\n                        // Add spinner before the icon\n                        const spinnerHTML = '<span class=\"spinner-border spinner-border-sm mr-2\" ' +\n                            'role=\"status\" aria-hidden=\"true\"></span>';\n                        activateBtn.innerHTML = spinnerHTML +\n                            '<i class=\"fa fa-rocket\"></i> ' + buttonText;\n                    }, 10);\n                }\n            });\n        }\n    }\n};\n"],"names":["getElement","id","document","getElementById","getElements","selector","querySelectorAll","initialStep","forEach","el","style","display","currentStepEl","classList","remove","currentIndicator","querySelector","add","hostingCards","hostingRadios","checkedRadio","checkedCard","closest","cardElement","card","addEventListener","radio","this","c","clickedCard","checked","cardEl","step2ValidateBtn","checkFormValidity","apiKey","_getElement","value","trim","apiSecret","_getElement2","s3InputBucket","_getElement3","s3OutputBucket","_getElement4","disabled","fieldId","field","awsForm","setTimeout","dataset","originalHtml","innerHTML","buttonText","Array","from","childNodes","filter","node","nodeType","Node","TEXT_NODE","map","textContent","join","spinnerHTML","hasExistingLicenseCheckbox","existingLicenseField","existingLicenseKeyInput","activateBtn","focus","iconMatch","match","icon","form","e","getAttribute","preventDefault","then","message","Toast","type"],"mappings":"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"}