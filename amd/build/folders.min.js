define("mod_videolesson/folders",["exports","core/ajax","core/notification","core/templates","core/str","core/modal_factory","core/modal_events","core/toast"],(function(_exports,_ajax,_notification,_templates,_str,_modal_factory,_modal_events,Toast){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Folder tree management and drag-and-drop functionality
   *
   * @module     mod_videolesson/folders
   * @copyright  2022-2026 BitKea Technologies LLP
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.loadFolderTree=_exports.init=_exports.getSelectedFolderId=_exports.getFolderTreeData=_exports.ensureFolderTreeData=void 0,_ajax=_interopRequireDefault(_ajax),_notification=_interopRequireDefault(_notification),_templates=_interopRequireDefault(_templates),_modal_factory=_interopRequireDefault(_modal_factory),_modal_events=_interopRequireDefault(_modal_events),Toast=function(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}newObj.default=obj,cache&&cache.set(obj,newObj);return newObj}(Toast);let selectedFolderId=0,folderTree=[];const resolveFolderId=value=>{if(null===value||"null"===value||"uncategorized"===value)return null;if(void 0===value||""===value||"all"===value)return 0;const parsed=parseInt(value,10);return Number.isNaN(parsed)?0:parsed},renderFolderInput=function(label){let value=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return _templates.default.render("mod_videolesson/folder_modal_form",{elementid:"videolesson-folder-name",label:label,name:"foldername",value:value,required:!0})};_exports.init=function(){let initialFolder=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(null!=initialFolder)selectedFolderId=resolveFolderId(initialFolder);else{const treeContainer=document.querySelector(".videolesson-folder-tree-container");treeContainer&&void 0!==treeContainer.dataset.selectedFolder&&(selectedFolderId=resolveFolderId(treeContainer.dataset.selectedFolder))}loadFolderTree(),setupEventListeners(),setupDragAndDrop(),document.addEventListener("videolesson:set-folder",(e=>{e.detail&&void 0!==e.detail.folderId&&selectFolder(resolveFolderId(e.detail.folderId),!1)}))};const loadFolderTree=async()=>{try{const response=await _ajax.default.call([{methodname:"mod_videolesson_get_folder_tree",args:{}}])[0];folderTree=response.folders,renderFolderTree(response.folders,response.uncategorizedcount,response.totalcount)}catch(error){_notification.default.exception(error)}};_exports.loadFolderTree=loadFolderTree;const renderFolderTree=async function(folders){let uncategorizedCount=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,totalCount=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;try{const context={folders:prepareFolderTreeData(folders),selected_folder:{is_root:0===selectedFolderId,is_uncategorized:null===selectedFolderId,value:null===selectedFolderId?"null":selectedFolderId},can_manage:!0,uncategorized_count:uncategorizedCount,totalcount:totalCount},html=await _templates.default.render("mod_videolesson/folder_tree",context),container=document.querySelector(".videolesson-folder-tree-container");container&&(container.innerHTML=html,container.dataset.selectedFolder=selectedFolderId,setupFolderInteractions(),updateCollapseAllButtonState())}catch(error){_notification.default.exception(error)}},prepareFolderTreeData=folders=>folders.map((folder=>{const hasChildren=folder.children&&folder.children.length>0,canCreateSubfolder=folder.depth<2,preparedFolder={...folder,has_children:hasChildren,can_create_subfolder:canCreateSubfolder,selected:null!==selectedFolderId&&parseInt(folder.id,10)===parseInt(selectedFolderId,10)};return hasChildren&&(preparedFolder.children=prepareFolderTreeData(folder.children)),preparedFolder})),setupEventListeners=()=>{document.body.addEventListener("click",(e=>{const renameButton=e.target.closest(".videolesson-rename-folder");if(renameButton){e.preventDefault(),e.stopPropagation();const folderIdAttr=renameButton.getAttribute("data-folder-id")||renameButton.dataset.folderId,folderId=parseInt(folderIdAttr,10);return isNaN(folderId)||folderId<=0?void _notification.default.exception(new Error("Invalid folder ID: "+folderIdAttr)):void showRenameFolderDialog(folderId).catch((error=>{_notification.default.exception(error)}))}if(e.target.closest(".videolesson-delete-folder")){e.preventDefault(),e.stopPropagation();const button=e.target.closest(".videolesson-delete-folder"),folderId=parseInt(button.dataset.folderId);return void showDeleteFolderDialog(folderId)}if(e.target.closest(".videolesson-create-folder, .videolesson-create-subfolder")){e.preventDefault(),e.stopPropagation();const parentId=e.target.closest(".videolesson-create-folder, .videolesson-create-subfolder").dataset.parentId||null;return void showCreateFolderDialog(parentId)}if(e.target.closest(".folder-toggle")){e.preventDefault(),e.stopPropagation();const button=e.target.closest(".folder-toggle");return toggleFolder(button),void updateCollapseAllButtonState()}if(e.target.closest(".videolesson-collapse-all")&&!e.target.closest(".folder-toggle"))return e.preventDefault(),e.stopPropagation(),void collapseAllFolders();if(e.target.closest(".videolesson-folder-item")){const folderItem=e.target.closest(".videolesson-folder-item");if(!e.target.closest(".folder-actions")&&!e.target.closest("button")&&!e.target.closest("a")){const folderId=resolveFolderId(folderItem.dataset.folderId);selectFolder(folderId)}e.stopPropagation()}}))},setupDragAndDrop=()=>{let isDragging=!1,dragLeaveTimeout=null;const getFolderContainer=()=>document.querySelector(".videolesson-folder-list"),updateSidebarDragState=active=>{const container=getFolderContainer();container&&(active?container.classList.add("drag-active"):container.classList.remove("drag-active"))};document.body.addEventListener("dragstart",(e=>{const handle=e.target.closest(".videolesson-drag-handle");if(!handle)return;const row=handle.closest("tr[data-videolesson-id]");if(!row)return;const videoId=parseInt(row.dataset.videolessonId);e.dataTransfer.setData("videolesson-id",videoId),e.dataTransfer.effectAllowed="move";const dragPreview=row.cloneNode(!0);dragPreview.style.position="absolute",dragPreview.style.top="-9999px",dragPreview.style.left="-9999px",dragPreview.style.width=row.offsetWidth+"px",dragPreview.style.background="#fff",dragPreview.style.boxShadow="0 4px 12px rgba(0,0,0,0.15)",dragPreview.style.opacity="0.95",document.body.appendChild(dragPreview),e.dataTransfer.setDragImage(dragPreview,20,20),setTimeout((()=>{document.body.removeChild(dragPreview)}),0),row.classList.add("dragging"),isDragging=!0,updateSidebarDragState(!0)})),document.body.addEventListener("dragend",(e=>{const row=e.target.closest("tr[data-videolesson-id]");row&&row.classList.remove("dragging"),document.querySelectorAll(".videolesson-folder-item.drag-over").forEach((item=>{item.classList.remove("drag-over")})),updateSidebarDragState(!1),isDragging=!1,dragLeaveTimeout&&(clearTimeout(dragLeaveTimeout),dragLeaveTimeout=null)})),document.body.addEventListener("dragover",(e=>{if(!isDragging||!e.dataTransfer.types.includes("videolesson-id"))return;const folderItem=e.target.closest('.videolesson-folder-item[data-droppable="true"]');if(folderItem)e.preventDefault(),e.dataTransfer.dropEffect="move",folderItem.classList.add("drag-over"),updateSidebarDragState(!1),dragLeaveTimeout&&(clearTimeout(dragLeaveTimeout),dragLeaveTimeout=null);else{const container=getFolderContainer();container&&container.contains(e.target)&&updateSidebarDragState(!0)}})),document.body.addEventListener("dragleave",(e=>{if(!isDragging)return;const folderItem=e.target.closest('.videolesson-folder-item[data-droppable="true"]');folderItem&&(folderItem.classList.remove("drag-over"),dragLeaveTimeout=setTimeout((()=>{const relatedTarget=e.relatedTarget,container=getFolderContainer();!container||relatedTarget&&container.contains(relatedTarget)||updateSidebarDragState(!0)}),10))})),document.body.addEventListener("drop",(async e=>{const folderItem=e.target.closest('.videolesson-folder-item[data-droppable="true"]');if(folderItem&&e.dataTransfer.types.includes("videolesson-id")){e.preventDefault(),folderItem.classList.remove("drag-over"),updateSidebarDragState(!1);const videoId=parseInt(e.dataTransfer.getData("videolesson-id")),folderId="null"===folderItem.dataset.folderId?null:"0"===folderItem.dataset.folderId?0:parseInt(folderItem.dataset.folderId);await moveVideo(videoId,folderId)}dragLeaveTimeout&&(clearTimeout(dragLeaveTimeout),dragLeaveTimeout=null)}))},setupFolderInteractions=()=>{},toggleFolder=button=>{const children=button.closest(".videolesson-folder-item").querySelector(".folder-children"),icon=button.querySelector("i");if(children){children.classList.contains("expanded")?(children.classList.remove("expanded"),button.setAttribute("aria-expanded","false"),icon&&(icon.style.transform="rotate(0deg)")):(children.classList.add("expanded"),button.setAttribute("aria-expanded","true"),icon&&(icon.style.transform="rotate(90deg)"))}},updateCollapseAllButtonState=()=>{const tree=document.querySelector(".videolesson-folder-tree-container"),collapseAllButton=document.querySelector(".videolesson-collapse-all");if(!tree||!collapseAllButton)return;const allToggleButtons=tree.querySelectorAll(".folder-toggle");if(0===allToggleButtons.length)return;let expandedCount=0,collapsedCount=0;allToggleButtons.forEach((button=>{const folderItem=button.closest(".videolesson-folder-item");if(!folderItem)return;const children=folderItem.querySelector(".folder-children");if(children){children.classList.contains("expanded")?expandedCount++:collapsedCount++}}));const shouldShowExpand=0===expandedCount||expandedCount<collapsedCount,collapseIcon=collapseAllButton.querySelector("i");collapseIcon&&(shouldShowExpand?(collapseIcon.classList.remove("fa-compress"),collapseIcon.classList.add("fa-expand"),(0,_str.get_string)("folder:expand_all","mod_videolesson").then((expandAllText=>{collapseAllButton.setAttribute("title",expandAllText),collapseAllButton.setAttribute("aria-label",expandAllText)}))):(collapseIcon.classList.remove("fa-expand"),collapseIcon.classList.add("fa-compress"),(0,_str.get_string)("folder:collapse_all","mod_videolesson").then((collapseAllText=>{collapseAllButton.setAttribute("title",collapseAllText),collapseAllButton.setAttribute("aria-label",collapseAllText)}))))},collapseAllFolders=()=>{const tree=document.querySelector(".videolesson-folder-tree-container");if(!tree)return;const allToggleButtons=tree.querySelectorAll(".folder-toggle");if(0===allToggleButtons.length)return;let expandedCount=0,collapsedCount=0;allToggleButtons.forEach((button=>{const folderItem=button.closest(".videolesson-folder-item");if(!folderItem)return;const children=folderItem.querySelector(".folder-children");if(children){children.classList.contains("expanded")?expandedCount++:collapsedCount++}}));const shouldExpand=0===expandedCount||expandedCount<collapsedCount;allToggleButtons.forEach((button=>{const folderItem=button.closest(".videolesson-folder-item");if(!folderItem)return;const children=folderItem.querySelector(".folder-children"),icon=button.querySelector("i");children&&(shouldExpand?(children.classList.add("expanded"),button.setAttribute("aria-expanded","true"),icon&&(icon.style.transform="rotate(90deg)")):(children.classList.remove("expanded"),button.setAttribute("aria-expanded","false"),icon&&(icon.style.transform="rotate(0deg)")))})),updateCollapseAllButtonState()},selectFolder=function(folderId){let triggerEvent=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];selectedFolderId=resolveFolderId(folderId),document.querySelectorAll(".videolesson-folder-item").forEach((item=>{item.classList.remove("selected")}));const selectorValue=null===selectedFolderId?"null":String(selectedFolderId),selectedItem=document.querySelector('[data-folder-id="'.concat(selectorValue,'"]'));if(selectedItem&&selectedItem.classList.add("selected"),triggerEvent){const event=new CustomEvent("videolesson:folder:selected",{detail:{folderId:selectedFolderId}});document.dispatchEvent(event)}},showCreateFolderDialog=async parentId=>{const strings=await Promise.all([(0,_str.get_string)("folder:create","mod_videolesson"),(0,_str.get_string)("folder:name","mod_videolesson"),(0,_str.get_string)("cancel"),(0,_str.get_string)("create")]);try{const body=await renderFolderInput(strings[1]),modal=await _modal_factory.default.create({type:_modal_factory.default.types.SAVE_CANCEL,title:strings[0],body:body});modal.getRoot().on(_modal_events.default.save,(async()=>{const name=modal.getRoot().find('input[name="'.concat("foldername",'"]')).val();name&&name.trim()&&(await createFolder(name.trim(),parentId),modal.destroy())})),modal.show()}catch(error){_notification.default.exception(error)}},findFolderInTree=(folders,folderId)=>{for(const folder of folders){if(parseInt(folder.id)===parseInt(folderId))return folder;if(folder.children&&folder.children.length>0){const found=findFolderInTree(folder.children,folderId);if(found)return found}}return null},isExcludedFolder=(folder,excludeFolderId)=>parseInt(folder.id,10)===parseInt(excludeFolderId,10),buildFolderOptions=function(folders,excludeFolderId){let currentParentId=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,depth=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;const options=[],indent=depth>0?"â€” ".repeat(depth):"";if(0===depth){const rootSelected=null===(null==currentParentId||0===currentParentId||"0"===currentParentId?null:parseInt(currentParentId,10));options.push({value:"0",label:"Root",selected:rootSelected})}for(const folder of folders){const folderId=parseInt(folder.id,10),excludeId=parseInt(excludeFolderId,10);if(isExcludedFolder(folder,excludeId))continue;if(folder.depth>=2)continue;const normalizedCurrentParent=null===currentParentId||0===currentParentId||"0"===currentParentId?null:parseInt(currentParentId,10),isSelected=null!==normalizedCurrentParent&&normalizedCurrentParent===folderId;if(options.push({value:folderId.toString(),label:indent+folder.name,selected:isSelected}),folder.children&&folder.children.length>0){const childOptions=buildFolderOptions(folder.children,excludeFolderId,currentParentId,depth+1);options.push(...childOptions)}}return options},showRenameFolderDialog=async folderId=>{const folder=findFolderInTree(folderTree,folderId);if(!folder)return void Toast.add("Folder not found",{type:"error"});const strings=await Promise.all([(0,_str.get_string)("folder:edit","mod_videolesson").catch((()=>(0,_str.get_string)("folder:rename","mod_videolesson"))),(0,_str.get_string)("folder:name","mod_videolesson"),(0,_str.get_string)("folder:select","mod_videolesson"),(0,_str.get_string)("cancel"),(0,_str.get_string)("savechanges")]);try{let currentParentId=folder.parent;if(null==currentParentId||0===currentParentId||"0"===currentParentId||""===currentParentId)currentParentId=null;else{const parsed=parseInt(currentParentId,10);currentParentId=isNaN(parsed)?null:parsed}const folderOptions=buildFolderOptions(folderTree,folderId,currentParentId);if(null!==currentParentId){if(folderOptions.some((opt=>parseInt(opt.value,10)===currentParentId)))folderOptions.forEach((opt=>{parseInt(opt.value,10)===currentParentId?opt.selected=!0:"0"!==opt.value&&(opt.selected=!1)}));else{const parentFolder=findFolderInTree(folderTree,currentParentId);if(parentFolder){const rootIndex=folderOptions.findIndex((opt=>"0"===opt.value)),insertIndex=rootIndex>=0?rootIndex+1:0;folderOptions.splice(insertIndex,0,{value:currentParentId.toString(),label:parentFolder.name,selected:!0})}}}const nameInput=await renderFolderInput(strings[1],folder.name),body=nameInput+await _templates.default.render("mod_videolesson/assign_folder_modal",{options:folderOptions}),modal=await _modal_factory.default.create({type:_modal_factory.default.types.SAVE_CANCEL,title:strings[0],body:body});modal.getRoot().on(_modal_events.default.save,(async()=>{const name=modal.getRoot().find('input[name="'.concat("foldername",'"]')).val();if(name&&name.trim()){const selectedParent=modal.getRoot().find("#videolesson-assign-folder-select").val();let newParentId=null;selectedParent&&"0"!==selectedParent&&"null"!==selectedParent&&(newParentId=parseInt(selectedParent,10),isNaN(newParentId)&&(newParentId=null)),await updateFolder(folderId,name.trim(),newParentId),modal.destroy()}})),modal.show()}catch(error){_notification.default.exception(error)}},showDeleteFolderDialog=async folderId=>{const strings=await Promise.all([(0,_str.get_string)("folder:delete","mod_videolesson"),(0,_str.get_string)("folder:delete_confirm","mod_videolesson"),(0,_str.get_string)("folder:delete_option_move","mod_videolesson"),(0,_str.get_string)("folder:delete_option_remove","mod_videolesson")]);try{const body="\n            <p>".concat(strings[1],'</p>\n            <div class="form-check">\n                <input class="form-check-input" type="radio"\n                    name="videolesson-delete-mode" id="videolesson-delete-move" value="move" checked>\n                <label class="form-check-label" for="videolesson-delete-move">').concat(strings[2],'</label>\n            </div>\n            <div class="form-check mt-2">\n                <input class="form-check-input" type="radio"\n                    name="videolesson-delete-mode" id="videolesson-delete-remove" value="delete">\n                <label class="form-check-label" for="videolesson-delete-remove">').concat(strings[3],"</label>\n            </div>"),modal=await _modal_factory.default.create({type:_modal_factory.default.types.SAVE_CANCEL,title:strings[0],body:body});modal.getRoot().on(_modal_events.default.save,(async()=>{const mode=modal.getRoot().find('input[name="videolesson-delete-mode"]:checked').val();await deleteFolder(folderId,"move"===mode),modal.destroy()})),modal.show()}catch(error){_notification.default.exception(error)}},createFolder=async(name,parentId)=>{try{const response=await _ajax.default.call([{methodname:"mod_videolesson_create_folder",args:{name:name,parentid:parentId||null}}])[0];response.success?(await loadFolderTree(),Toast.add(await(0,_str.get_string)("folder:create_success","mod_videolesson"))):Toast.add(response.error||await(0,_str.get_string)("folder:create_error","mod_videolesson"),{type:"error"})}catch(error){_notification.default.exception(error)}},updateFolder=async function(folderId,name){let parentId=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;try{const response=await _ajax.default.call([{methodname:"mod_videolesson_update_folder",args:{folderid:folderId,name:name,parentid:parentId}}])[0];response.success?(await loadFolderTree(),Toast.add(await(0,_str.get_string)("folder:update_success","mod_videolesson"))):Toast.add(response.error||await(0,_str.get_string)("folder:update_error","mod_videolesson"),{type:"error"})}catch(error){_notification.default.exception(error)}},deleteFolder=async function(folderId){let moveVideos=arguments.length>1&&void 0!==arguments[1]&&arguments[1];try{const response=await _ajax.default.call([{methodname:"mod_videolesson_delete_folder",args:{folderid:folderId,movevideos:moveVideos}}])[0];response.success?(await loadFolderTree(),Toast.add(await(0,_str.get_string)("folder:delete_success","mod_videolesson")),document.dispatchEvent(new CustomEvent("videolesson:folder:selected",{detail:{folderId:0}}))):Toast.add(response.error||await(0,_str.get_string)("folder:delete_error","mod_videolesson"),{type:"error"})}catch(error){_notification.default.exception(error)}},moveVideo=async(videoId,folderId)=>{try{const response=await _ajax.default.call([{methodname:"mod_videolesson_move_video",args:{videolessonid:videoId,folderid:folderId}}])[0];if(response.success){const msg=await(0,_str.get_string)("folder:move_video_success","mod_videolesson");Toast.add(msg),await loadFolderTree();const event=new CustomEvent("videolesson:folder:selected",{detail:{folderId:selectedFolderId}});document.dispatchEvent(event)}else Toast.add(response.error||await(0,_str.get_string)("folder:move_video_error","mod_videolesson"),{type:"error"})}catch(error){_notification.default.exception(error)}};_exports.getSelectedFolderId=()=>selectedFolderId;_exports.getFolderTreeData=()=>folderTree.slice();_exports.ensureFolderTreeData=async()=>(folderTree.length||await loadFolderTree(),folderTree.slice())}));

//# sourceMappingURL=folders.min.js.map