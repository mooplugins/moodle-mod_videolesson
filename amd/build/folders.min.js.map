{"version":3,"file":"folders.min.js","sources":["../src/folders.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Folder tree management and drag-and-drop functionality\n *\n * @module     mod_videolesson/folders\n * @copyright  2022-2026 BitKea Technologies LLP\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Ajax from 'core/ajax';\nimport Notification from 'core/notification';\nimport Templates from 'core/templates';\nimport {get_string as getString} from 'core/str';\nimport ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\nimport * as Toast from 'core/toast';\n\nlet selectedFolderId = 0;\nlet folderTree = [];\nconst folderInputName = 'foldername';\nconst folderInputId = 'videolesson-folder-name';\n\nconst resolveFolderId = (value) => {\n    if (value === null || value === 'null' || value === 'uncategorized') {\n        return null;\n    }\n    if (value === undefined || value === '' || value === 'all') {\n        return 0;\n    }\n    const parsed = parseInt(value, 10);\n    return Number.isNaN(parsed) ? 0 : parsed;\n};\n\n/**\n * Render folder input field for modal dialogs.\n *\n * @param {String} label Input label text\n * @param {String} value Default value\n * @return {Promise<String>} Rendered HTML\n */\nconst renderFolderInput = (label, value = '') => Templates.render('mod_videolesson/folder_modal_form', {\n    elementid: folderInputId,\n    label: label,\n    name: folderInputName,\n    value: value,\n    required: true,\n});\n\n/**\n * Initialize folder tree\n * @param {number|null} initialFolder Initial folder ID\n */\nexport const init = (initialFolder = null) => {\n    if (initialFolder !== null && typeof initialFolder !== 'undefined') {\n        selectedFolderId = resolveFolderId(initialFolder);\n    } else {\n        const treeContainer = document.querySelector('.videolesson-folder-tree-container');\n        if (treeContainer && treeContainer.dataset.selectedFolder !== undefined) {\n            selectedFolderId = resolveFolderId(treeContainer.dataset.selectedFolder);\n        }\n    }\n    loadFolderTree();\n    setupEventListeners();\n    setupDragAndDrop();\n\n    document.addEventListener('videolesson:set-folder', (e) => {\n        if (e.detail && typeof e.detail.folderId !== 'undefined') {\n            selectFolder(resolveFolderId(e.detail.folderId), false);\n        }\n    });\n};\n\n/**\n * Load folder tree from server\n * @returns {Promise<void>}\n */\nexport const loadFolderTree = async () => {\n    try {\n        const response = await Ajax.call([{\n            methodname: 'mod_videolesson_get_folder_tree',\n            args: {}\n        }])[0];\n\n        folderTree = response.folders;\n        renderFolderTree(response.folders, response.uncategorizedcount, response.totalcount);\n    } catch (error) {\n        Notification.exception(error);\n    }\n};\n\n/**\n * Render folder tree\n *\n * @param {Array} folders Array of folder objects\n * @param {number} uncategorizedCount Number of uncategorized videos\n * @param {number} totalCount Total count of all videos\n */\nconst renderFolderTree = async (folders, uncategorizedCount = 0, totalCount = 0) => {\n    try {\n        const context = {\n            folders: prepareFolderTreeData(folders),\n            selected_folder: {\n                is_root: selectedFolderId === 0,\n                is_uncategorized: selectedFolderId === null,\n                value: selectedFolderId === null ? 'null' : selectedFolderId\n            },\n            can_manage: true,\n            uncategorized_count: uncategorizedCount,\n            totalcount: totalCount\n        };\n\n        const html = await Templates.render('mod_videolesson/folder_tree', context);\n        const container = document.querySelector('.videolesson-folder-tree-container');\n        if (container) {\n            container.innerHTML = html;\n            container.dataset.selectedFolder = selectedFolderId;\n            setupFolderInteractions();\n            updateCollapseAllButtonState();\n        }\n    } catch (error) {\n        Notification.exception(error);\n    }\n};\n\n/**\n * Prepare folder tree data for template (recursive)\n *\n * @param {Array} folders Array of folder objects\n * @return {Array} Prepared folder data\n */\nconst prepareFolderTreeData = (folders) => {\n    return folders.map(folder => {\n        const hasChildren = folder.children && folder.children.length > 0;\n        const canCreateSubfolder = folder.depth < 2; // Max depth is 3, so can create if depth < 2\n        const preparedFolder = {\n            ...folder,\n            has_children: hasChildren,\n            can_create_subfolder: canCreateSubfolder,\n            selected: (selectedFolderId !== null) && (parseInt(folder.id, 10) === parseInt(selectedFolderId, 10))\n        };\n\n        // Recursively prepare children\n        if (hasChildren) {\n            preparedFolder.children = prepareFolderTreeData(folder.children);\n        }\n\n        return preparedFolder;\n    });\n};\n\n/**\n * Setup event listeners\n */\nconst setupEventListeners = () => {\n    document.body.addEventListener('click', (e) => {\n        // Handle action buttons first (before folder selection to prevent interference)\n        // Rename folder button (check for button or icon inside)\n        const renameButton = e.target.closest('.videolesson-rename-folder');\n        if (renameButton) {\n            e.preventDefault();\n            e.stopPropagation(); // Prevent folder selection from firing\n            const folderIdAttr = renameButton.getAttribute('data-folder-id') || renameButton.dataset.folderId;\n            const folderId = parseInt(folderIdAttr, 10);\n            if (isNaN(folderId) || folderId <= 0) {\n                Notification.exception(new Error('Invalid folder ID: ' + folderIdAttr));\n                return;\n            }\n            showRenameFolderDialog(folderId).catch(error => {\n                Notification.exception(error);\n            });\n            return;\n        }\n\n        // Delete folder button\n        if (e.target.closest('.videolesson-delete-folder')) {\n            e.preventDefault();\n            e.stopPropagation(); // Prevent folder selection from firing\n            const button = e.target.closest('.videolesson-delete-folder');\n            const folderId = parseInt(button.dataset.folderId);\n            showDeleteFolderDialog(folderId);\n            return;\n        }\n\n        // Create folder button\n        if (e.target.closest('.videolesson-create-folder, .videolesson-create-subfolder')) {\n            e.preventDefault();\n            e.stopPropagation(); // Prevent folder selection from firing\n            const button = e.target.closest('.videolesson-create-folder, .videolesson-create-subfolder');\n            const parentId = button.dataset.parentId || null;\n            showCreateFolderDialog(parentId);\n            return;\n        }\n\n        // Folder toggle (expand/collapse) - check this BEFORE collapse all to prevent conflicts\n        if (e.target.closest('.folder-toggle')) {\n            e.preventDefault();\n            e.stopPropagation(); // Prevent folder selection from firing\n            const button = e.target.closest('.folder-toggle');\n            toggleFolder(button);\n            // Update collapse all button state after individual folder toggle\n            updateCollapseAllButtonState();\n            return;\n        }\n\n        // Collapse all folders - must check that we're NOT clicking on a folder toggle\n        const collapseAllLink = e.target.closest('.videolesson-collapse-all');\n        if (collapseAllLink && !e.target.closest('.folder-toggle')) {\n            e.preventDefault();\n            e.stopPropagation();\n            collapseAllFolders();\n            return;\n        }\n\n        // Folder selection (only if not clicking on action buttons)\n        if (e.target.closest('.videolesson-folder-item')) {\n            const folderItem = e.target.closest('.videolesson-folder-item');\n            // Don't select if clicking on folder-actions or any button inside\n            if (!e.target.closest('.folder-actions') &&\n                !e.target.closest('button') &&\n                !e.target.closest('a')) {\n                const folderId = resolveFolderId(folderItem.dataset.folderId);\n                selectFolder(folderId);\n            }\n            e.stopPropagation();\n        }\n    });\n};\n\n/**\n * Setup drag and drop\n */\nconst setupDragAndDrop = () => {\n    let isDragging = false;\n    let dragLeaveTimeout = null;\n\n    // Helper to get folder sidebar/container element\n    const getFolderContainer = () => {\n        return document.querySelector('.videolesson-folder-list');\n    };\n\n    // Helper to update sidebar drag-active state\n    const updateSidebarDragState = (active) => {\n        const container = getFolderContainer();\n        if (container) {\n            if (active) {\n                container.classList.add('drag-active');\n            } else {\n                container.classList.remove('drag-active');\n            }\n        }\n    };\n\n    // Make video table rows draggable via handle only.\n    document.body.addEventListener('dragstart', (e) => {\n        const handle = e.target.closest('.videolesson-drag-handle');\n        if (!handle) {\n            return;\n        }\n\n        const row = handle.closest('tr[data-videolesson-id]');\n        if (!row) {\n            return;\n        }\n\n        const videoId = parseInt(row.dataset.videolessonId);\n\n        e.dataTransfer.setData('videolesson-id', videoId);\n        e.dataTransfer.effectAllowed = 'move';\n\n        // ---- Create drag image from full row ----\n        const dragPreview = row.cloneNode(true);\n        dragPreview.style.position = 'absolute';\n        dragPreview.style.top = '-9999px';\n        dragPreview.style.left = '-9999px';\n        dragPreview.style.width = row.offsetWidth + 'px';\n        dragPreview.style.background = '#fff';\n        dragPreview.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';\n        dragPreview.style.opacity = '0.95';\n\n        document.body.appendChild(dragPreview);\n\n        e.dataTransfer.setDragImage(dragPreview, 20, 20);\n\n        // Remove after drag starts\n        setTimeout(() => {\n            document.body.removeChild(dragPreview);\n        }, 0);\n\n        row.classList.add('dragging');\n        isDragging = true;\n        updateSidebarDragState(true);\n    });\n\n    document.body.addEventListener('dragend', (e) => {\n        const row = e.target.closest('tr[data-videolesson-id]');\n        if (row) {\n            row.classList.remove('dragging');\n        }\n        document.querySelectorAll('.videolesson-folder-item.drag-over').forEach(item => {\n            item.classList.remove('drag-over');\n        });\n        // Remove sidebar highlight when drag ends\n        updateSidebarDragState(false);\n        isDragging = false;\n        if (dragLeaveTimeout) {\n            clearTimeout(dragLeaveTimeout);\n            dragLeaveTimeout = null;\n        }\n    });\n\n    // Folder drop zones\n    document.body.addEventListener('dragover', (e) => {\n        if (!isDragging || !e.dataTransfer.types.includes('videolesson-id')) {\n            return;\n        }\n\n        const folderItem = e.target.closest('.videolesson-folder-item[data-droppable=\"true\"]');\n        if (folderItem) {\n            e.preventDefault();\n            e.dataTransfer.dropEffect = 'move';\n            folderItem.classList.add('drag-over');\n            // Remove sidebar highlight when over a specific folder item\n            updateSidebarDragState(false);\n            if (dragLeaveTimeout) {\n                clearTimeout(dragLeaveTimeout);\n                dragLeaveTimeout = null;\n            }\n        } else {\n            // If not over a folder item, ensure sidebar is highlighted\n            const container = getFolderContainer();\n            if (container && container.contains(e.target)) {\n                updateSidebarDragState(true);\n            }\n        }\n    });\n\n    document.body.addEventListener('dragleave', (e) => {\n        if (!isDragging) {\n            return;\n        }\n\n        const folderItem = e.target.closest('.videolesson-folder-item[data-droppable=\"true\"]');\n        if (folderItem) {\n            folderItem.classList.remove('drag-over');\n            // Use timeout to check if we're leaving to go to another folder item\n            // or leaving the folder area entirely\n            dragLeaveTimeout = setTimeout(() => {\n                const relatedTarget = e.relatedTarget;\n                const container = getFolderContainer();\n                if (container && (!relatedTarget || !container.contains(relatedTarget))) {\n                    // Not entering another folder item, highlight sidebar\n                    updateSidebarDragState(true);\n                }\n            }, 10);\n        }\n    });\n\n    document.body.addEventListener('drop', async (e) => {\n        const folderItem = e.target.closest('.videolesson-folder-item[data-droppable=\"true\"]');\n        if (folderItem && e.dataTransfer.types.includes('videolesson-id')) {\n            e.preventDefault();\n            folderItem.classList.remove('drag-over');\n            // Remove sidebar highlight on drop\n            updateSidebarDragState(false);\n\n            const videoId = parseInt(e.dataTransfer.getData('videolesson-id'));\n            const folderId = folderItem.dataset.folderId === 'null' ? null :\n                           (folderItem.dataset.folderId === '0' ? 0 : parseInt(folderItem.dataset.folderId));\n\n            await moveVideo(videoId, folderId);\n        }\n        if (dragLeaveTimeout) {\n            clearTimeout(dragLeaveTimeout);\n            dragLeaveTimeout = null;\n        }\n    });\n};\n\n/**\n * Setup folder interactions after render\n */\nconst setupFolderInteractions = () => {\n    // Restore expanded state if needed\n    // Add any additional setup here\n};\n\n/**\n * Toggle folder expand/collapse\n *\n * @param {HTMLElement} button Toggle button element\n */\nconst toggleFolder = (button) => {\n    const folderItem = button.closest('.videolesson-folder-item');\n    const children = folderItem.querySelector('.folder-children');\n    const icon = button.querySelector('i');\n\n    if (children) {\n        const isExpanded = children.classList.contains('expanded');\n        if (isExpanded) {\n            // Collapse\n            children.classList.remove('expanded');\n            button.setAttribute('aria-expanded', 'false');\n            if (icon) {\n                icon.style.transform = 'rotate(0deg)';\n            }\n        } else {\n            // Expand\n            children.classList.add('expanded');\n            button.setAttribute('aria-expanded', 'true');\n            if (icon) {\n                icon.style.transform = 'rotate(90deg)';\n            }\n        }\n    }\n};\n\n/**\n * Update the collapse/expand all button state based on current folder tree state\n */\nconst updateCollapseAllButtonState = () => {\n    const tree = document.querySelector('.videolesson-folder-tree-container');\n    const collapseAllButton = document.querySelector('.videolesson-collapse-all');\n\n    if (!tree || !collapseAllButton) {\n        return;\n    }\n\n    const allToggleButtons = tree.querySelectorAll('.folder-toggle');\n    if (allToggleButtons.length === 0) {\n        return;\n    }\n\n    // Check current state: count how many are expanded vs collapsed\n    let expandedCount = 0;\n    let collapsedCount = 0;\n\n    allToggleButtons.forEach((button) => {\n        const folderItem = button.closest('.videolesson-folder-item');\n        if (!folderItem) {\n            return;\n        }\n\n        const children = folderItem.querySelector('.folder-children');\n        if (children) {\n            const isExpanded = children.classList.contains('expanded');\n            if (isExpanded) {\n                expandedCount++;\n            } else {\n                collapsedCount++;\n            }\n        }\n    });\n\n    // Determine if button should show expand or collapse\n    const shouldShowExpand = expandedCount === 0 || expandedCount < collapsedCount;\n    const collapseIcon = collapseAllButton.querySelector('i');\n\n    if (collapseIcon) {\n        if (shouldShowExpand) {\n            collapseIcon.classList.remove('fa-compress');\n            collapseIcon.classList.add('fa-expand');\n            getString('folder:expand_all', 'mod_videolesson').then((expandAllText) => {\n                collapseAllButton.setAttribute('title', expandAllText);\n                collapseAllButton.setAttribute('aria-label', expandAllText);\n            });\n        } else {\n            collapseIcon.classList.remove('fa-expand');\n            collapseIcon.classList.add('fa-compress');\n            getString('folder:collapse_all', 'mod_videolesson').then((collapseAllText) => {\n                collapseAllButton.setAttribute('title', collapseAllText);\n                collapseAllButton.setAttribute('aria-label', collapseAllText);\n            });\n        }\n    }\n};\n\n/**\n * Toggle expand/collapse all folders in the tree\n */\nconst collapseAllFolders = () => {\n    const tree = document.querySelector('.videolesson-folder-tree-container');\n    if (!tree) {\n        return;\n    }\n\n    const allToggleButtons = tree.querySelectorAll('.folder-toggle');\n    if (allToggleButtons.length === 0) {\n        return;\n    }\n\n    // Check current state: count how many are expanded vs collapsed\n    let expandedCount = 0;\n    let collapsedCount = 0;\n\n    allToggleButtons.forEach((button) => {\n        const folderItem = button.closest('.videolesson-folder-item');\n        if (!folderItem) {\n            return;\n        }\n\n        const children = folderItem.querySelector('.folder-children');\n        if (children) {\n            const isExpanded = children.classList.contains('expanded');\n            if (isExpanded) {\n                expandedCount++;\n            } else {\n                collapsedCount++;\n            }\n        }\n    });\n\n    // Determine action: if more expanded than collapsed, collapse all; otherwise expand all\n    const shouldExpand = expandedCount === 0 || expandedCount < collapsedCount;\n\n    // Apply the action\n    allToggleButtons.forEach((button) => {\n        const folderItem = button.closest('.videolesson-folder-item');\n        if (!folderItem) {\n            return;\n        }\n\n        const children = folderItem.querySelector('.folder-children');\n        const icon = button.querySelector('i');\n\n        if (children) {\n            if (shouldExpand) {\n                // Expand all\n                children.classList.add('expanded');\n                button.setAttribute('aria-expanded', 'true');\n                if (icon) {\n                    icon.style.transform = 'rotate(90deg)';\n                }\n            } else {\n                // Collapse all\n                children.classList.remove('expanded');\n                button.setAttribute('aria-expanded', 'false');\n                if (icon) {\n                    icon.style.transform = 'rotate(0deg)';\n                }\n            }\n        }\n    });\n\n    // Update the button state after toggling\n    updateCollapseAllButtonState();\n};\n\n/**\n * Update UI and optionally dispatch selection event.\n *\n * @param {number|null} folderId\n * @param {boolean} triggerEvent\n */\nconst selectFolder = (folderId, triggerEvent = true) => {\n    selectedFolderId = resolveFolderId(folderId);\n\n    // Update UI\n    document.querySelectorAll('.videolesson-folder-item').forEach(item => {\n        item.classList.remove('selected');\n    });\n\n    const selectorValue = selectedFolderId === null ? 'null' : String(selectedFolderId);\n    const selectedItem = document.querySelector(`[data-folder-id=\"${selectorValue}\"]`);\n    if (selectedItem) {\n        selectedItem.classList.add('selected');\n    }\n\n    if (triggerEvent) {\n        const event = new CustomEvent('videolesson:folder:selected', {\n            detail: {folderId: selectedFolderId}\n        });\n        document.dispatchEvent(event);\n    }\n};\n\n/**\n * Show create folder dialog\n *\n * @param {number|null} parentId Parent folder ID\n */\nconst showCreateFolderDialog = async (parentId) => {\n    const strings = await Promise.all([\n        getString('folder:create', 'mod_videolesson'),\n        getString('folder:name', 'mod_videolesson'),\n        getString('cancel'),\n        getString('create')\n    ]);\n\n    try {\n        const body = await renderFolderInput(strings[1]);\n        const modal = await ModalFactory.create({\n            type: ModalFactory.types.SAVE_CANCEL,\n            title: strings[0],\n            body: body\n        });\n\n        modal.getRoot().on(ModalEvents.save, async () => {\n            const name = modal.getRoot().find(`input[name=\"${folderInputName}\"]`).val();\n            if (name && name.trim()) {\n                await createFolder(name.trim(), parentId);\n                modal.destroy();\n            }\n        });\n\n        modal.show();\n    } catch (error) {\n        Notification.exception(error);\n    }\n};\n\n/**\n * Recursively find a folder in the tree by ID\n *\n * @param {Array} folders Array of folder objects to search\n * @param {number} folderId Folder ID to find\n * @return {Object|null} Found folder object or null\n */\nconst findFolderInTree = (folders, folderId) => {\n    for (const folder of folders) {\n        if (parseInt(folder.id) === parseInt(folderId)) {\n            return folder;\n        }\n        if (folder.children && folder.children.length > 0) {\n            const found = findFolderInTree(folder.children, folderId);\n            if (found) {\n                return found;\n            }\n        }\n    }\n    return null;\n};\n\n/**\n * Check if a folder is the excluded folder itself\n *\n * @param {Object} folder Folder to check\n * @param {number} excludeFolderId Folder ID to exclude\n * @return {boolean} True if folder is the excluded folder\n */\nconst isExcludedFolder = (folder, excludeFolderId) => {\n    return parseInt(folder.id, 10) === parseInt(excludeFolderId, 10);\n};\n\n/**\n * Check if a folder is a descendant of the excluded folder\n * (used to skip children of the excluded folder)\n *\n * @param {Object} folder Folder to check\n * @param {number} excludeFolderId Folder ID to exclude\n * @return {boolean} True if folder is a descendant of the excluded folder\n */\n// const isDescendantOf = (folder, excludeFolderId) => {\n//     // This function is only called when processing children of folders\n//     // It checks if the current folder is the excluded folder or a descendant\n//     if (parseInt(folder.id, 10) === parseInt(excludeFolderId, 10)) {\n//         return true;\n//     }\n//     if (folder.children && folder.children.length > 0) {\n//         return folder.children.some(child => isDescendantOf(child, excludeFolderId));\n//     }\n//     return false;\n// };\n\n/**\n * Build folder options for select dropdown, excluding current folder and its descendants\n *\n * @param {Array} folders Folder tree array\n * @param {number} excludeFolderId Folder ID to exclude (and its descendants)\n * @param {number|null} currentParentId Current parent ID to mark as selected\n * @param {number} depth Current depth level\n * @return {Array} Array of option objects {value, label, selected}\n */\nconst buildFolderOptions = (folders, excludeFolderId, currentParentId = null, depth = 0) => {\n    const options = [];\n    const indent = depth > 0 ? 'â€” '.repeat(depth) : '';\n\n    // Add \"Root\" option (no parent)\n    if (depth === 0) {\n        // Normalize currentParentId for comparison\n        const isNullParent = currentParentId === null ||\n            currentParentId === undefined ||\n            currentParentId === 0 ||\n            currentParentId === '0';\n        const normalizedCurrentParent = isNullParent ? null : parseInt(currentParentId, 10);\n        const rootSelected = normalizedCurrentParent === null;\n        options.push({\n            value: '0',\n            label: 'Root',\n            selected: rootSelected\n        });\n    }\n\n    for (const folder of folders) {\n        const folderId = parseInt(folder.id, 10);\n        const excludeId = parseInt(excludeFolderId, 10);\n\n        // Skip only if this folder IS the excluded folder itself\n        if (isExcludedFolder(folder, excludeId)) {\n            // Don't add this folder, but we can still process its siblings\n            continue;\n        }\n\n        // Skip folders at depth 2 or higher (max depth is 3, so depth 2 cannot be a parent)\n        if (folder.depth >= 2) {\n            // Don't add this folder as a parent option, but we can still process its children\n            // (though they would be depth 3 which shouldn't exist)\n            continue;\n        }\n\n        // Normalize both IDs for comparison\n        const isNullParent = currentParentId === null ||\n            currentParentId === 0 ||\n            currentParentId === '0';\n        const normalizedCurrentParent = isNullParent ? null : parseInt(currentParentId, 10);\n        const isSelected = normalizedCurrentParent !== null && normalizedCurrentParent === folderId;\n        options.push({\n            value: folderId.toString(),\n            label: indent + folder.name,\n            selected: isSelected\n        });\n\n        // Recursively add children, but skip the excluded folder and its descendants\n        if (folder.children && folder.children.length > 0) {\n            const childOptions = buildFolderOptions(folder.children, excludeFolderId, currentParentId, depth + 1);\n            options.push(...childOptions);\n        }\n    }\n\n    return options;\n};\n\n/**\n * Show edit folder dialog (rename and change parent)\n *\n * @param {number} folderId Folder ID to edit\n */\nconst showRenameFolderDialog = async (folderId) => {\n    const folder = findFolderInTree(folderTree, folderId);\n    if (!folder) {\n        Toast.add('Folder not found', {type: 'error'});\n        return;\n    }\n\n    const strings = await Promise.all([\n        getString('folder:edit', 'mod_videolesson').catch(() => getString('folder:rename', 'mod_videolesson')),\n        getString('folder:name', 'mod_videolesson'),\n        getString('folder:select', 'mod_videolesson'),\n        getString('cancel'),\n        getString('savechanges')\n    ]);\n\n    try {\n        // Normalize current parent ID for comparison\n        // Handle both null and numeric parent IDs from the tree structure\n        let currentParentId = folder.parent;\n        const isNullParent = currentParentId === null ||\n            currentParentId === undefined ||\n            currentParentId === 0 ||\n            currentParentId === '0' ||\n            currentParentId === '';\n        if (isNullParent) {\n            currentParentId = null;\n        } else {\n            // Convert to integer, handling both string and number types\n            const parsed = parseInt(currentParentId, 10);\n            currentParentId = isNaN(parsed) ? null : parsed;\n        }\n\n        // Build folder options (excluding current folder and its descendants)\n        const folderOptions = buildFolderOptions(folderTree, folderId, currentParentId);\n\n        // Verify parent is in options - if not, add it manually\n        if (currentParentId !== null) {\n            const parentInOptions = folderOptions.some(opt => {\n                const optId = parseInt(opt.value, 10);\n                return optId === currentParentId;\n            });\n\n            if (!parentInOptions) {\n                // Parent folder not found in options, find it in tree and add it\n                const parentFolder = findFolderInTree(folderTree, currentParentId);\n                if (parentFolder) {\n                    // Insert parent folder option at the beginning (after Root)\n                    const rootIndex = folderOptions.findIndex(opt => opt.value === '0');\n                    const insertIndex = rootIndex >= 0 ? rootIndex + 1 : 0;\n                    folderOptions.splice(insertIndex, 0, {\n                        value: currentParentId.toString(),\n                        label: parentFolder.name,\n                        selected: true\n                    });\n                }\n            } else {\n                // Parent is in options, ensure it's selected\n                folderOptions.forEach(opt => {\n                    const optId = parseInt(opt.value, 10);\n                    if (optId === currentParentId) {\n                        opt.selected = true;\n                    } else if (opt.value !== '0') {\n                        opt.selected = false;\n                    }\n                });\n            }\n        }\n\n        // Render modal body with name input and folder selector\n        const nameInput = await renderFolderInput(strings[1], folder.name);\n        const folderSelect = await Templates.render('mod_videolesson/assign_folder_modal', {\n            options: folderOptions\n        });\n\n        const body = nameInput + folderSelect;\n\n        const modal = await ModalFactory.create({\n            type: ModalFactory.types.SAVE_CANCEL,\n            title: strings[0],\n            body: body\n        });\n\n        modal.getRoot().on(ModalEvents.save, async () => {\n            const name = modal.getRoot().find(`input[name=\"${folderInputName}\"]`).val();\n            if (name && name.trim()) {\n                // Get selected parent folder\n                const selectedParent = modal.getRoot().find('#videolesson-assign-folder-select').val();\n                let newParentId = null;\n                if (selectedParent && selectedParent !== '0' && selectedParent !== 'null') {\n                    newParentId = parseInt(selectedParent, 10);\n                    if (isNaN(newParentId)) {\n                        newParentId = null;\n                    }\n                }\n\n                await updateFolder(folderId, name.trim(), newParentId);\n                modal.destroy();\n            }\n        });\n\n        modal.show();\n    } catch (error) {\n        Notification.exception(error);\n    }\n};\n\n/**\n * Show delete folder dialog\n *\n * @param {number} folderId Folder ID to delete\n */\nconst showDeleteFolderDialog = async (folderId) => {\n    const strings = await Promise.all([\n        getString('folder:delete', 'mod_videolesson'),\n        getString('folder:delete_confirm', 'mod_videolesson'),\n        getString('folder:delete_option_move', 'mod_videolesson'),\n        getString('folder:delete_option_remove', 'mod_videolesson')\n    ]);\n\n    try {\n        const body = `\n            <p>${strings[1]}</p>\n            <div class=\"form-check\">\n                <input class=\"form-check-input\" type=\"radio\"\n                    name=\"videolesson-delete-mode\" id=\"videolesson-delete-move\" value=\"move\" checked>\n                <label class=\"form-check-label\" for=\"videolesson-delete-move\">${strings[2]}</label>\n            </div>\n            <div class=\"form-check mt-2\">\n                <input class=\"form-check-input\" type=\"radio\"\n                    name=\"videolesson-delete-mode\" id=\"videolesson-delete-remove\" value=\"delete\">\n                <label class=\"form-check-label\" for=\"videolesson-delete-remove\">${strings[3]}</label>\n            </div>`;\n\n        const modal = await ModalFactory.create({\n            type: ModalFactory.types.SAVE_CANCEL,\n            title: strings[0],\n            body: body\n        });\n\n        modal.getRoot().on(ModalEvents.save, async () => {\n            const mode = modal.getRoot().find('input[name=\"videolesson-delete-mode\"]:checked').val();\n            await deleteFolder(folderId, mode === 'move');\n            modal.destroy();\n        });\n\n        modal.show();\n    } catch (error) {\n        Notification.exception(error);\n    }\n};\n\n/**\n * Create folder\n *\n * @param {string} name Folder name\n * @param {number|null} parentId Parent folder ID\n */\nconst createFolder = async (name, parentId) => {\n    try {\n        const response = await Ajax.call([{\n            methodname: 'mod_videolesson_create_folder',\n            args: {\n                name: name,\n                parentid: parentId || null\n            }\n        }])[0];\n\n        if (response.success) {\n            await loadFolderTree();\n            Toast.add(await getString('folder:create_success', 'mod_videolesson'));\n        } else {\n            Toast.add(response.error || await getString('folder:create_error', 'mod_videolesson'), {type: 'error'});\n        }\n    } catch (error) {\n        Notification.exception(error);\n    }\n};\n\n/**\n * Update folder\n *\n * @param {number} folderId Folder ID to update\n * @param {string} name New folder name\n * @param {number|null} parentId New parent folder ID\n */\nconst updateFolder = async (folderId, name, parentId = null) => {\n    try {\n        const response = await Ajax.call([{\n            methodname: 'mod_videolesson_update_folder',\n            args: {\n                folderid: folderId,\n                name: name,\n                parentid: parentId\n            }\n        }])[0];\n\n        if (response.success) {\n            await loadFolderTree();\n            Toast.add(await getString('folder:update_success', 'mod_videolesson'));\n        } else {\n            Toast.add(response.error || await getString('folder:update_error', 'mod_videolesson'), {type: 'error'});\n        }\n    } catch (error) {\n        Notification.exception(error);\n    }\n};\n\n/**\n * Delete folder\n *\n * @param {number} folderId Folder ID to delete\n * @param {boolean} moveVideos Whether to move videos to the root folder\n */\nconst deleteFolder = async (folderId, moveVideos = false) => {\n    try {\n        const response = await Ajax.call([{\n            methodname: 'mod_videolesson_delete_folder',\n            args: {\n                folderid: folderId,\n                movevideos: moveVideos\n            }\n        }])[0];\n\n        if (response.success) {\n            await loadFolderTree();\n            Toast.add(await getString('folder:delete_success', 'mod_videolesson'));\n            document.dispatchEvent(new CustomEvent('videolesson:folder:selected', {\n                detail: {folderId: 0}\n            }));\n        } else {\n            Toast.add(response.error || await getString('folder:delete_error', 'mod_videolesson'), {type: 'error'});\n        }\n    } catch (error) {\n        Notification.exception(error);\n    }\n};\n\n/**\n * Move video to folder\n *\n * @param {number} videoId Video ID to move\n * @param {number|null} folderId Target folder ID\n */\nconst moveVideo = async (videoId, folderId) => {\n    try {\n        const response = await Ajax.call([{\n            methodname: 'mod_videolesson_move_video',\n            args: {\n                videolessonid: videoId,\n                folderid: folderId\n            }\n        }])[0];\n\n        if (response.success) {\n            const msg = await getString('folder:move_video_success', 'mod_videolesson');\n            Toast.add(msg);\n\n            // Reload folder tree counts and refresh current folder listing.\n            await loadFolderTree();\n            const event = new CustomEvent('videolesson:folder:selected', {\n                detail: {folderId: selectedFolderId}\n            });\n            document.dispatchEvent(event);\n        } else {\n            Toast.add(response.error || await getString('folder:move_video_error', 'mod_videolesson'), {type: 'error'});\n        }\n    } catch (error) {\n        Notification.exception(error);\n    }\n};\n\n/**\n * Get selected folder ID\n */\nexport const getSelectedFolderId = () => {\n    return selectedFolderId;\n};\n\nexport const getFolderTreeData = () => {\n    return folderTree.slice();\n};\n\nexport const ensureFolderTreeData = async () => {\n    if (!folderTree.length) {\n        await loadFolderTree();\n    }\n    return folderTree.slice();\n};\n\n"],"names":["selectedFolderId","folderTree","resolveFolderId","value","undefined","parsed","parseInt","Number","isNaN","renderFolderInput","label","Templates","render","elementid","name","required","initialFolder","treeContainer","document","querySelector","dataset","selectedFolder","loadFolderTree","setupEventListeners","setupDragAndDrop","addEventListener","e","detail","folderId","selectFolder","async","response","Ajax","call","methodname","args","folders","renderFolderTree","uncategorizedcount","totalcount","error","exception","uncategorizedCount","totalCount","context","prepareFolderTreeData","selected_folder","is_root","is_uncategorized","can_manage","uncategorized_count","html","container","innerHTML","setupFolderInteractions","updateCollapseAllButtonState","map","folder","hasChildren","children","length","canCreateSubfolder","depth","preparedFolder","has_children","can_create_subfolder","selected","id","body","renameButton","target","closest","preventDefault","stopPropagation","folderIdAttr","getAttribute","Error","showRenameFolderDialog","catch","button","showDeleteFolderDialog","parentId","showCreateFolderDialog","toggleFolder","collapseAllFolders","folderItem","isDragging","dragLeaveTimeout","getFolderContainer","updateSidebarDragState","active","classList","add","remove","handle","row","videoId","videolessonId","dataTransfer","setData","effectAllowed","dragPreview","cloneNode","style","position","top","left","width","offsetWidth","background","boxShadow","opacity","appendChild","setDragImage","setTimeout","removeChild","querySelectorAll","forEach","item","clearTimeout","types","includes","dropEffect","contains","relatedTarget","getData","moveVideo","icon","setAttribute","transform","tree","collapseAllButton","allToggleButtons","expandedCount","collapsedCount","shouldShowExpand","collapseIcon","then","expandAllText","collapseAllText","shouldExpand","triggerEvent","selectorValue","String","selectedItem","event","CustomEvent","dispatchEvent","strings","Promise","all","modal","ModalFactory","create","type","SAVE_CANCEL","title","getRoot","on","ModalEvents","save","find","val","trim","createFolder","destroy","show","findFolderInTree","found","isExcludedFolder","excludeFolderId","buildFolderOptions","currentParentId","options","indent","repeat","rootSelected","push","excludeId","normalizedCurrentParent","isSelected","toString","childOptions","Toast","parent","folderOptions","some","opt","parentFolder","rootIndex","findIndex","insertIndex","splice","nameInput","selectedParent","newParentId","updateFolder","mode","deleteFolder","parentid","success","folderid","moveVideos","movevideos","videolessonid","msg","slice"],"mappings":"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"}