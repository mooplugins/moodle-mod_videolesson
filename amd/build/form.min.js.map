{"version":3,"file":"form.min.js","sources":["../src/form.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Form functionality for videolesson plugin\n *\n * @module     mod_videolesson/form\n * @copyright  2022-2026 BitKea Technologies LLP\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Notification from \"core/notification\";\nimport * as Str from 'core/str';\nimport {initTable} from 'mod_videolesson/table';\nlet restrict = false;\nlet awsdependent = ['aws', 'upload'];\nexport const init = (params) => {\n    restrict = params.restrict;\n    const contenthash = document.getElementById('id_contenthash');\n    const sourceElement = document.getElementById('id_source');\n    const galleryContainer = document.getElementById('video_gallery_container');\n    const completionunlockedElement = document.getElementsByName('completionunlocked')[0];\n    const completionunlocked = completionunlockedElement ? completionunlockedElement : null;\n    const instance = document.getElementsByName('instance')[0];\n    const videourl = document.getElementsByName('videourl')[0];\n\n    let originalValueUrl = videourl.value;\n    let originalValue = sourceElement.value;\n    let originalValueContenthash = contenthash.value;\n    let notified = false;\n\n    initTable();\n\n    const table = document.getElementById('videolist');\n    table.addEventListener('click', function(event) {\n        console.log('table click', event); // eslint-disable-line no-console\n        const clickedRow = event.target.closest('tbody tr');\n        console.log('clickedRow', clickedRow); // eslint-disable-line no-console\n        if (clickedRow) {\n            if (originalValueContenthash && originalValueContenthash != clickedRow.getAttribute('data-contenthash')) {\n                changeVideoConfirm(clickedRow, changeVideo);\n            } else {\n                changeVideo(clickedRow);\n            }\n        }\n    });\n\n    const changeVideoConfirm = (clickedRowOrEvent, saveCallback, cancelCallback = null, cancelParam = null) => {\n        // Determine if we received a row element or an event object\n        const isRow = clickedRowOrEvent && clickedRowOrEvent.nodeType === 1; // Element node\n        const isEvent = clickedRowOrEvent && clickedRowOrEvent.target;\n        const row = isRow ? clickedRowOrEvent : null;\n        const event = isEvent ? clickedRowOrEvent : null;\n\n        if (event && restrict && awsdependent.includes(event.target.value) ) {\n            noconfigConfirm();\n            sourceElement.value = originalValue;\n            return;\n        }\n        if (notified || !instance.value) {\n            saveCallback(row || clickedRowOrEvent);\n            return;\n        }\n\n        Str.get_strings([\n            {key: 'modform:videochange:title', component: 'mod_videolesson'},\n            {key: 'modform:videochange:content', component: 'mod_videolesson'},\n            {key: 'modform:videochange:yes', component: 'mod_videolesson'},\n            {key: 'modform:videochange:cancel', component: 'mod_videolesson'}\n        ]).then(function(strings) {\n            Notification.confirm(\n                strings[0],\n                strings[1],\n                strings[2],\n                strings[3],\n                () => {\n                    notified = true;\n                    saveCallback(row || clickedRowOrEvent);\n                },\n                () => {\n                    if(cancelCallback !== null) {\n                        cancelCallback(cancelParam);\n                    }\n                }\n            );\n        }).catch(Notification.exception);\n    };\n\n    const noconfigConfirm = () => {\n\n        Str.get_strings([\n            {key: 'modform:noconfig:alert:title', component: 'mod_videolesson'},\n            {key: 'modform:noconfig:alert:content', component: 'mod_videolesson'},\n            {key: 'modform:noconfig:alert:button', component: 'mod_videolesson'}\n        ]).then(function(strings) {\n            Notification.alert(\n                strings[0],\n                strings[1],\n                strings[2],\n            );\n        }).catch(Notification.exception);\n    };\n\n    const changeVideo = (clickedRow) => {\n        console.log('changeVideo', clickedRow); // eslint-disable-line no-console\n        // Handle case where clickedRow might be an event (for backward compatibility)\n        const row = clickedRow && clickedRow.nodeType ? clickedRow :\n                    (clickedRow && clickedRow.currentTarget ? clickedRow.currentTarget : null);\n\n        if (!row) {\n            console.error('changeVideo: Invalid row element', clickedRow); // eslint-disable-line no-console\n            return;\n        }\n\n        const rowContenthash = row.getAttribute('data-contenthash');\n        if (completionunlocked && originalValueContenthash != rowContenthash) {\n            completionunlocked.value = 1;\n        }\n\n        contenthash.value = rowContenthash;\n        var rows = document.getElementById('videolist').getElementsByTagName('tr');\n        for (var i = 0; i < rows.length; i++) {\n            rows[i].classList.remove('selected');\n        }\n        row.classList.add('selected');\n    };\n\n    const changeUrlConfirm = (event) => {\n        if (originalValueUrl) {\n            event.preventDefault();\n            changeVideoConfirm(event,changeUrlSave, changeUrlCancel, originalValueUrl);\n        }\n    };\n\n    const changeUrlSave = () => {\n        // do nothing.\n    };\n\n    const changeUrlCancel = (original) => {\n        videourl.value = original;\n    };\n\n    const changeSource = (event) => {\n        event.preventDefault();\n        changeVideoConfirm(event,toggleContainerVisibility, SetselectOriginalVale, originalValue);\n    };\n\n    const SetselectOriginalVale = (original) => {\n        sourceElement.value = original;\n        toggleContainerVisibility();\n    };\n\n    const toggleContainerVisibility = () => {\n\n        const removeSpecificStyle = (element, property) => {\n            element.style.removeProperty(property);\n        };\n\n        const setSpecificStyle = (element, property, value) => {\n            element.style.setProperty(property,value);\n        };\n\n        let toShowElementIds = [];\n        let toHideElementIds = [];\n        switch (sourceElement.value) {\n            case 'upload':\n                toShowElementIds = ['fitem_id_newvideo', 'fitem_id_thumbnail'];\n                toHideElementIds = ['fitem_id_videourl', 'fitem_id_embedcode'];\n                if (params.restrict) {toShowElementIds.push('fitem_id_missingconfig');}\n                galleryContainer.classList.toggle('d-none', true);\n                break;\n            case 'aws':\n                toShowElementIds = ['video_gallery_container', 'fitem_id_thumbnail'];\n                toHideElementIds = ['fitem_id_newvideo', 'fitem_id_videourl', 'fitem_id_embedcode'];\n                if (params.restrict) {toShowElementIds.push('fitem_id_missingconfig');}\n                galleryContainer.classList.toggle('d-none', false);\n                break;\n            case 'external':\n                toShowElementIds = ['fitem_id_videourl'];\n                toHideElementIds = ['fitem_id_newvideo', 'video_gallery_container', 'fitem_id_thumbnail','fitem_id_embedcode'];\n                if (params.restrict) {toHideElementIds.push('fitem_id_missingconfig');}\n                galleryContainer.classList.toggle('d-none', true);\n                break;\n            case 'embed':\n                toShowElementIds = ['fitem_id_embedcode'];\n                toHideElementIds = ['fitem_id_newvideo', 'video_gallery_container', 'fitem_id_thumbnail','fitem_id_videourl'];\n                if (params.restrict) {toHideElementIds.push('fitem_id_missingconfig');}\n                galleryContainer.classList.toggle('d-none', true);\n                break;\n            default:\n                break;\n        }\n\n        toShowElementIds.forEach(function(id) {\n            var element = document.getElementById(id);\n            if (element) {\n                removeSpecificStyle(element, 'display');\n            }\n        });\n\n        toHideElementIds.forEach(function(id) {\n            var element = document.getElementById(id);\n            if (element) {\n                setSpecificStyle(element, 'display', 'none');\n            }\n        });\n\n    };\n\n    sourceElement.addEventListener('change', changeSource);\n    videourl.addEventListener('input', changeUrlConfirm);\n    toggleContainerVisibility();\n};\n"],"names":["restrict","awsdependent","params","contenthash","document","getElementById","sourceElement","galleryContainer","completionunlockedElement","getElementsByName","completionunlocked","instance","videourl","originalValueUrl","value","originalValue","originalValueContenthash","notified","addEventListener","event","console","log","clickedRow","target","closest","getAttribute","changeVideoConfirm","changeVideo","clickedRowOrEvent","saveCallback","cancelCallback","cancelParam","isRow","nodeType","isEvent","row","includes","noconfigConfirm","Str","get_strings","key","component","then","strings","confirm","catch","Notification","exception","alert","currentTarget","error","rowContenthash","rows","getElementsByTagName","i","length","classList","remove","add","changeUrlSave","changeUrlCancel","original","SetselectOriginalVale","toggleContainerVisibility","toShowElementIds","toHideElementIds","push","toggle","forEach","id","element","property","style","removeProperty","removeSpecificStyle","setProperty","setSpecificStyle","preventDefault"],"mappings":";;;;;;;mkCA0BIA,UAAW,EACXC,aAAe,CAAC,MAAO,wBACNC,SACjBF,SAAWE,OAAOF,eACZG,YAAcC,SAASC,eAAe,kBACtCC,cAAgBF,SAASC,eAAe,aACxCE,iBAAmBH,SAASC,eAAe,2BAC3CG,0BAA4BJ,SAASK,kBAAkB,sBAAsB,GAC7EC,mBAAqBF,2BAAwD,KAC7EG,SAAWP,SAASK,kBAAkB,YAAY,GAClDG,SAAWR,SAASK,kBAAkB,YAAY,OAEpDI,iBAAmBD,SAASE,MAC5BC,cAAgBT,cAAcQ,MAC9BE,yBAA2Bb,YAAYW,MACvCG,UAAW,yBAIDb,SAASC,eAAe,aAChCa,iBAAiB,SAAS,SAASC,OACrCC,QAAQC,IAAI,cAAeF,aACrBG,WAAaH,MAAMI,OAAOC,QAAQ,YACxCJ,QAAQC,IAAI,aAAcC,YACtBA,aACIN,0BAA4BA,0BAA4BM,WAAWG,aAAa,oBAChFC,mBAAmBJ,WAAYK,aAE/BA,YAAYL,sBAKlBI,mBAAqB,SAACE,kBAAmBC,kBAAcC,sEAAiB,KAAMC,mEAAc,WAExFC,MAAQJ,mBAAoD,IAA/BA,kBAAkBK,SAC/CC,QAAUN,mBAAqBA,kBAAkBL,OACjDY,IAAMH,MAAQJ,kBAAoB,KAClCT,MAAQe,QAAUN,kBAAoB,QAExCT,OAASnB,UAAYC,aAAamC,SAASjB,MAAMI,OAAOT,cACxDuB,uBACA/B,cAAcQ,MAAQC,gBAGtBE,UAAaN,SAASG,MAK1BwB,IAAIC,YAAY,CACZ,CAACC,IAAK,4BAA6BC,UAAW,mBAC9C,CAACD,IAAK,8BAA+BC,UAAW,mBAChD,CAACD,IAAK,0BAA2BC,UAAW,mBAC5C,CAACD,IAAK,6BAA8BC,UAAW,qBAChDC,MAAK,SAASC,+BACAC,QACTD,QAAQ,GACRA,QAAQ,GACRA,QAAQ,GACRA,QAAQ,IACR,KACI1B,UAAW,EACXY,aAAaM,KAAOP,sBAExB,KAC0B,OAAnBE,gBACCA,eAAeC,mBAI5Bc,MAAMC,sBAAaC,WAzBlBlB,aAAaM,KAAOP,oBA4BtBS,gBAAkB,KAEpBC,IAAIC,YAAY,CACZ,CAACC,IAAK,+BAAgCC,UAAW,mBACjD,CAACD,IAAK,iCAAkCC,UAAW,mBACnD,CAACD,IAAK,gCAAiCC,UAAW,qBACnDC,MAAK,SAASC,+BACAK,MACTL,QAAQ,GACRA,QAAQ,GACRA,QAAQ,OAEbE,MAAMC,sBAAaC,YAGpBpB,YAAeL,aACjBF,QAAQC,IAAI,cAAeC,kBAErBa,IAAMb,YAAcA,WAAWW,SAAWX,WACnCA,YAAcA,WAAW2B,cAAgB3B,WAAW2B,cAAgB,SAE5Ed,gBACDf,QAAQ8B,MAAM,mCAAoC5B,kBAIhD6B,eAAiBhB,IAAIV,aAAa,oBACpCf,oBAAsBM,0BAA4BmC,iBAClDzC,mBAAmBI,MAAQ,GAG/BX,YAAYW,MAAQqC,uBAChBC,KAAOhD,SAASC,eAAe,aAAagD,qBAAqB,MAC5DC,EAAI,EAAGA,EAAIF,KAAKG,OAAQD,IAC7BF,KAAKE,GAAGE,UAAUC,OAAO,YAE7BtB,IAAIqB,UAAUE,IAAI,aAUhBC,cAAgB,OAIhBC,gBAAmBC,WACrBjD,SAASE,MAAQ+C,UAQfC,sBAAyBD,WAC3BvD,cAAcQ,MAAQ+C,SACtBE,6BAGEA,0BAA4B,SAU1BC,iBAAmB,GACnBC,iBAAmB,UACf3D,cAAcQ,WACb,SACDkD,iBAAmB,CAAC,oBAAqB,sBACzCC,iBAAmB,CAAC,oBAAqB,sBACrC/D,OAAOF,UAAWgE,iBAAiBE,KAAK,0BAC5C3D,iBAAiBiD,UAAUW,OAAO,UAAU,aAE3C,MACDH,iBAAmB,CAAC,0BAA2B,sBAC/CC,iBAAmB,CAAC,oBAAqB,oBAAqB,sBAC1D/D,OAAOF,UAAWgE,iBAAiBE,KAAK,0BAC5C3D,iBAAiBiD,UAAUW,OAAO,UAAU,aAE3C,WACDH,iBAAmB,CAAC,qBACpBC,iBAAmB,CAAC,oBAAqB,0BAA2B,qBAAqB,sBACrF/D,OAAOF,UAAWiE,iBAAiBC,KAAK,0BAC5C3D,iBAAiBiD,UAAUW,OAAO,UAAU,aAE3C,QACDH,iBAAmB,CAAC,sBACpBC,iBAAmB,CAAC,oBAAqB,0BAA2B,qBAAqB,qBACrF/D,OAAOF,UAAWiE,iBAAiBC,KAAK,0BAC5C3D,iBAAiBiD,UAAUW,OAAO,UAAU,GAMpDH,iBAAiBI,SAAQ,SAASC,QAC1BC,QAAUlE,SAASC,eAAegE,IAClCC,SAzCoB,EAACA,QAASC,YAClCD,QAAQE,MAAMC,eAAeF,WAyCzBG,CAAoBJ,QAAS,cAIrCL,iBAAiBG,SAAQ,SAASC,QAC1BC,QAAUlE,SAASC,eAAegE,IAClCC,SA5CiB,EAACA,QAASC,SAAUzD,SACzCwD,QAAQE,MAAMG,YAAYJ,SAASzD,QA4C/B8D,CAAiBN,QAAS,UAAW,YAMjDhE,cAAcY,iBAAiB,UAnETC,QAClBA,MAAM0D,iBACNnD,mBAAmBP,MAAM4C,0BAA2BD,sBAAuB/C,kBAkE/EH,SAASM,iBAAiB,SAnFAC,QAClBN,mBACAM,MAAM0D,iBACNnD,mBAAmBP,MAAMwC,cAAeC,gBAAiB/C,sBAiFjEkD"}