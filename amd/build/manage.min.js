define("mod_videolesson/manage",["exports","core/ajax","core/modal_factory","core/modal_events","core/templates","mod_videolesson/script","core/notification","core/str","mod_videolesson/folders","core/inplace_editable","core/toast","mod_videolesson/debug"],(function(_exports,_ajax,_modal_factory,_modal_events,_templates,_script,_notification,_str,_folders,_inplace_editable,Toast,Debug){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Manage functionality for videolesson plugin
   *
   * @module     mod_videolesson/manage
   * @copyright  2022-2026 BitKea Technologies LLP
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_ajax=_interopRequireDefault(_ajax),_modal_factory=_interopRequireDefault(_modal_factory),_modal_events=_interopRequireDefault(_modal_events),_templates=_interopRequireDefault(_templates),_notification=_interopRequireDefault(_notification),Toast=_interopRequireWildcard(Toast),Debug=_interopRequireWildcard(Debug);let tableContainer,videoPlayer,currentFolder=0,currentSearch="",currentPage=0,perPage=10,isLoading=!1;const folderParamToId=value=>{if(null==value||""===value||"all"===value)return 0;if("uncategorized"===value||"null"===value)return null;const parsed=parseInt(value,10);return Number.isNaN(parsed)?0:parsed},folderIdToParam=value=>null===value?"uncategorized":0===value||void 0===value?"all":String(value),showTableSpinner=()=>{tableContainer&&tableContainer.classList.add("videolesson-loading")},hideTableSpinner=()=>{tableContainer&&tableContainer.classList.remove("videolesson-loading")},updateHistory=function(){let replace=arguments.length>0&&void 0!==arguments[0]&&arguments[0];const url=new URL(window.location.href),folderParam=folderIdToParam(currentFolder);"all"===folderParam?url.searchParams.delete("folder"):url.searchParams.set("folder",folderParam),url.searchParams.delete("folderid"),currentSearch?url.searchParams.set("search",currentSearch):url.searchParams.delete("search"),url.searchParams.set("vpage",currentPage),url.searchParams.set("vperpage",perPage);const state={folder:folderParam,search:currentSearch,page:currentPage};replace?window.history.replaceState(state,"",url.toString()):window.history.pushState(state,"",url.toString())},highlightFolder=folder=>{document.dispatchEvent(new CustomEvent("videolesson:set-folder",{detail:{folderId:folder}}))},loadVideos=async function(){let{folderId:folderId=currentFolder,search:search=currentSearch,page:page=currentPage,pushState:pushState=!0,replaceState:replaceState=!1}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(!isLoading&&(tableContainer||(tableContainer=document.getElementById("videolesson-table-container")),tableContainer)){isLoading=!0,showTableSpinner();try{const folderParam=folderIdToParam(folderId),response=await _ajax.default.call([{methodname:"mod_videolesson_get_videos",args:{folderid:folderParam,search:search,page:page,perpage:perPage}}])[0],html=await _templates.default.render("mod_videolesson/library_table",response),wrapper=tableContainer.querySelector("#videolesson-table-wrapper");wrapper?wrapper.outerHTML=html:tableContainer.insertAdjacentHTML("beforeend",html),currentFolder=folderParamToId(response.filters.folderid),currentSearch=response.filters.search,currentPage=response.pagination.page,perPage=response.pagination.perpage,highlightFolder(currentFolder),setupBulkActions(),initTableSorting(),pushState&&updateHistory(replaceState)}catch(error){_notification.default.exception(error)}finally{hideTableSpinner(),isLoading=!1}}},initTableSorting=()=>{const table=document.getElementById("videolesson-table");if(!table)return;const sortableHeaders=table.querySelectorAll("th.videolesson-sortable");let currentSort={column:null,direction:"asc"};sortableHeaders.forEach((header=>{header.style.cursor="pointer",header.style.userSelect="none",header.addEventListener("click",(()=>{const column=header.getAttribute("data-sort-column");currentSort.column===column?currentSort.direction="asc"===currentSort.direction?"desc":"asc":(currentSort.column=column,currentSort.direction="asc"),sortableHeaders.forEach((h=>{const indicator=h.querySelector(".sort-indicator");indicator&&(indicator.textContent="")}));const indicator=header.querySelector(".sort-indicator");indicator&&(indicator.textContent="asc"===currentSort.direction?" ▲":" ▼"),sortTableRows(table,column,currentSort.direction)}))}))},sortTableRows=(table,column,direction)=>{const tbody=table.querySelector("tbody");if(!tbody)return;const rows=Array.from(tbody.querySelectorAll("tr:not(.d-none)"));rows.sort(((a,b)=>{const aValue=a.getAttribute("data-sort-".concat(column))||"",bValue=b.getAttribute("data-sort-".concat(column))||"";if("instances"===column||"timecreated"===column){const aNum=parseFloat(aValue)||0,bNum=parseFloat(bValue)||0;return"asc"===direction?aNum-bNum:bNum-aNum}const aText=aValue.toLowerCase(),bText=bValue.toLowerCase();return"asc"===direction?aText.localeCompare(bText):bText.localeCompare(aText)})),tbody.innerHTML="",rows.forEach((row=>tbody.appendChild(row))),setupBulkActions()},flattenFolderOptions=function(folders){let selectedId=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,depth=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,options=[];return folders.forEach((folder=>{if(folder.depth>=2)return;const indent=depth>0?"".concat("— ".repeat(depth)):"";options.push({value:folder.id,label:"".concat(indent).concat(folder.name),selected:null!==selectedId&&parseInt(folder.id,10)===parseInt(selectedId,10)}),folder.children&&folder.children.length&&(options=options.concat(flattenFolderOptions(folder.children,selectedId,depth+1)))})),options},getSelectedVideoIds=()=>{const checkboxes=document.querySelectorAll(".videolesson-video-checkbox:checked");return Array.from(checkboxes).map((cb=>parseInt(cb.dataset.videoId,10)))},updateBulkActions=()=>{const selectedIds=getSelectedVideoIds(),bulkActions=document.getElementById("videolesson-bulk-actions"),selectedCount=document.getElementById("videolesson-selected-count"),selectAll=document.getElementById("videolesson-select-all");if(bulkActions&&selectedCount&&(selectedIds.length>0?(bulkActions.classList.remove("d-none"),(0,_str.get_string)("bulk:selected_count","mod_videolesson").then((str=>{selectedCount.textContent="".concat(selectedIds.length," ").concat(str)}))):bulkActions.classList.add("d-none")),selectAll){const allCheckboxes=document.querySelectorAll(".videolesson-video-checkbox"),checkedCount=document.querySelectorAll(".videolesson-video-checkbox:checked").length;selectAll.checked=allCheckboxes.length>0&&checkedCount===allCheckboxes.length,selectAll.indeterminate=checkedCount>0&&checkedCount<allCheckboxes.length}},setupBulkActions=()=>{const selectAll=document.getElementById("videolesson-select-all"),bulkMove=document.querySelector(".videolesson-bulk-move"),bulkDelete=document.querySelector(".videolesson-bulk-delete");selectAll&&selectAll.addEventListener("change",(e=>{document.querySelectorAll(".videolesson-video-checkbox").forEach((cb=>{cb.checked=e.target.checked})),updateBulkActions()})),document.querySelectorAll(".videolesson-video-checkbox").forEach((checkbox=>{checkbox.addEventListener("change",(()=>{updateBulkActions()}))})),bulkMove&&bulkMove.addEventListener("click",(async e=>{e.preventDefault();const selectedIds=getSelectedVideoIds();0!==selectedIds.length?await handleBulkMove(selectedIds):Toast.add(await(0,_str.get_string)("bulk:no_selection","mod_videolesson"),{type:"error"})})),bulkDelete&&bulkDelete.addEventListener("click",(async e=>{e.preventDefault();const selectedIds=getSelectedVideoIds();0!==selectedIds.length?await handleBulkDelete(selectedIds):Toast.add(await(0,_str.get_string)("bulk:no_selection","mod_videolesson"),{type:"error"})})),updateBulkActions()},getLoadingBody=function(){let message=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Loading...";return'<div class="text-center p-3"><div class="spinner-border text-primary" role="status"><span class="sr-only">Loading...</span></div>'+(message?'<p class="mt-2">'.concat(message,"</p>"):"")+"</div>"},handleBulkMove=async videoIds=>{try{const[title,selectLabel,uncategorizedLabel]=await Promise.all([(0,_str.get_string)("bulk:move","mod_videolesson"),(0,_str.get_string)("folder:select","mod_videolesson"),(0,_str.get_string)("folder:uncategorized","mod_videolesson")]),loadingBody=getLoadingBody("Loading folders..."),modal=await _modal_factory.default.create({type:_modal_factory.default.types.SAVE_CANCEL,title:title,body:loadingBody});modal.show();const selectedCheckboxes=document.querySelectorAll(".videolesson-video-checkbox:checked"),folderIds=new Set;let defaultFolderId=null;if(selectedCheckboxes.forEach((checkbox=>{const row=checkbox.closest("tr.videolesson-draggable-row");if(row){const folderIdAttr=row.getAttribute("data-folder-id");folderIdAttr&&"null"!==folderIdAttr&&folderIds.add(folderIdAttr)}})),1===folderIds.size){const folderIdValue=Array.from(folderIds)[0];defaultFolderId="null"===folderIdValue?null:parseInt(folderIdValue,10)}else null!==currentFolder&&0!==currentFolder&&(defaultFolderId=currentFolder);const tree=await(0,_folders.ensureFolderTreeData)(),options=[{value:"",label:uncategorizedLabel,selected:null===defaultFolderId},...flattenFolderOptions(tree,defaultFolderId)],body=await _templates.default.render("mod_videolesson/assign_folder_modal",{label:selectLabel,options:options});modal.getRoot().find(".modal-body").html(body),modal.getRoot().on(_modal_events.default.save,(async()=>{const selected=modal.getRoot().find("#videolesson-assign-folder-select").val(),folderId=""===selected?null:parseInt(selected,10);try{const response=await _ajax.default.call([{methodname:"mod_videolesson_bulk_move_videos",args:{videoids:videoIds,folderid:folderId}}])[0];if(response.success){const msg=await(0,_str.get_string)("bulk:move_success","mod_videolesson");Toast.add(msg),modal.destroy(),await(0,_folders.loadFolderTree)(),await loadVideos({folderId:currentFolder,search:currentSearch,page:currentPage,pushState:!1,replaceState:!0})}else Toast.add(response.error||await(0,_str.get_string)("bulk:error","mod_videolesson"),{type:"error"})}catch(error){_notification.default.exception(error)}})),modal.show()}catch(error){_notification.default.exception(error)}},handleBulkDelete=async videoIds=>{try{const[confirmTitle,confirmBody,cancelText,yesText]=await Promise.all([(0,_str.get_string)("confirmation","mod_videolesson"),(0,_str.get_string)("bulk:confirm_delete","mod_videolesson").then((msg=>msg.replace("{$a}",videoIds.length))),(0,_str.get_string)("cancel"),(0,_str.get_string)("yes","moodle")]),modal=await _modal_factory.default.create({type:_modal_factory.default.types.SAVE_CANCEL,title:confirmTitle,body:confirmBody,buttons:{cancel:cancelText,save:yesText}});modal.getRoot().one(_modal_events.default.save,(function(e){e.preventDefault(),e.stopPropagation(),(async()=>{const loadingBody=getLoadingBody("Deleting videos...");modal.getRoot().find(".modal-body").html(loadingBody),modal.getRoot().find('[data-action="save"]').prop("disabled",!0),modal.getRoot().find('[data-action="cancel"]').prop("disabled",!0);try{const response=await _ajax.default.call([{methodname:"mod_videolesson_bulk_delete_videos",args:{videoids:videoIds}}])[0];if(modal.destroy(),response.success){const msg=await(0,_str.get_string)("bulk:delete_success","mod_videolesson");Toast.add(msg),await loadVideos({folderId:currentFolder,search:currentSearch,page:currentPage,pushState:!1,replaceState:!0}),await(0,_folders.loadFolderTree)()}else Toast.add(response.error||await(0,_str.get_string)("bulk:error","mod_videolesson"),{type:"error"})}catch(error){modal.destroy(),_notification.default.exception(error)}})()})),modal.show()}catch(error){_notification.default.exception(error)}},assignFolder=async(videoId,folderValue)=>{const targetFolder=null===folderValue?null:parseInt(folderValue,10);try{const response=await _ajax.default.call([{methodname:"mod_videolesson_move_video",args:{videolessonid:parseInt(videoId,10),folderid:targetFolder}}])[0];if(response.success){const msg=await(0,_str.get_string)("folder:move_video_success","mod_videolesson");Toast.add(msg),await(0,_folders.loadFolderTree)(),await loadVideos({folderId:currentFolder,search:currentSearch,page:currentPage,pushState:!1,replaceState:!0})}else Toast.add(response.error||await(0,_str.get_string)("folder:move_video_error","mod_videolesson"),{type:"error"})}catch(error){_notification.default.exception(error)}},viewVideoModal=async params=>{document.getElementById("videolesson-modal-loading").style.display="flex";const renderedBody=await _templates.default.render("mod_videolesson/view_modal",params);let tracks=[];try{tracks=await(0,_script.getSubtitles)(params.contenthash)}catch(error){Debug.error("Error fetching subtitles",error),_notification.default.exception(error)}_modal_factory.default.create({title:params.title,body:renderedBody,type:_modal_factory.default.types.CANCEL,footer:"",large:!0}).then((function(modal){return modal.getRoot().on(_modal_events.default.hidden,(function(){modal.destroy()})),modal.getRoot().on(_modal_events.default.shown,(function(){let v=modal.getRoot().find("#player")[0],c=modal.getRoot().find("#player-container-div")[0],p=modal.getRoot().find("#player-placeholder")[0],params={ishls:!0,video:v};(0,_script.addSubtitleTracks)(v,tracks),(0,_script.initializePlayer)(params).then((videoPlyr=>{videoPlayer=videoPlyr})).then((()=>{c.classList.remove("d-none"),p.classList.add("d-none")}))})),document.getElementById("videolesson-modal-loading").style.display="none",modal.show(),!0})).catch(_notification.default.exception)};_exports.init=()=>{tableContainer=document.getElementById("videolesson-table-container"),tableContainer&&(currentFolder=folderParamToId(tableContainer.dataset.initialFolder||"all"),currentSearch=tableContainer.dataset.initialSearch||"",currentPage=parseInt(tableContainer.dataset.initialPage||"0",10),perPage=parseInt(tableContainer.dataset.perPage||"10",10)),window.onload=function(){if("view"===(0,_script.getUrlParameter)("action")){const src=(0,_script.getUrlParameter)("src"),title=(0,_script.getUrlParameter)("title");""!==src&&viewVideoModal({sourceurl:src,title:title})}},document.querySelector(".videolesson-folder-tree-container")&&((0,_folders.init)(currentFolder),document.addEventListener("videolesson:folder:selected",(e=>{const folderId=e.detail&&void 0!==e.detail.folderId?e.detail.folderId:folderParamToId(e.detail.folder);loadVideos({folderId:folderId,page:0})})));const filterForm=document.querySelector('form[name="filter-videos"]');if(filterForm){const searchInput=filterForm.querySelector('input[name="_text"]'),resetButton=filterForm.querySelector('button[value="reset"]');filterForm.addEventListener("submit",(e=>{e.preventDefault();const value=searchInput?searchInput.value:"";loadVideos({folderId:currentFolder,search:value,page:0})})),resetButton&&resetButton.addEventListener("click",(e=>{e.preventDefault(),searchInput&&(searchInput.value=""),loadVideos({folderId:currentFolder,search:"",page:0})}))}document.body.addEventListener("click",(function(event){const target=event.target,legacyLink=target.closest(".videolesson-viewmodal-href");if(legacyLink){event.preventDefault();const fragment=legacyLink.getAttribute("href"),url=new URL("http://dummy.com"+fragment),src=new URLSearchParams(url.hash.substring(1)).get("videolesson-src"),hash=legacyLink.getAttribute("data-videolesson-contenthash");let modalparams={sourceurl:src,title:legacyLink.textContent.trim(),contenthash:hash};viewVideoModal(modalparams)}const viewBtn=target.closest(".videolesson-viewmodal-data");if(viewBtn){event.preventDefault();const src=viewBtn.getAttribute("data-videolesson-src"),hash=viewBtn.getAttribute("data-videolesson-contenthash"),title=viewBtn.getAttribute("data-videolesson-title")||"";viewVideoModal({sourceurl:src,title:title,contenthash:hash})}const thumbnail=target.closest(".videolesson-viewmodal-thumbnail");if(thumbnail){event.preventDefault();const src=thumbnail.getAttribute("data-videolesson-src"),hash=thumbnail.getAttribute("data-videolesson-contenthash"),title=thumbnail.getAttribute("data-videolesson-title")||"";viewVideoModal({sourceurl:src,title:title,contenthash:hash})}const paginate=target.closest(".videolesson-page-link");if(paginate){event.preventDefault();const nextpage=parseInt(paginate.dataset.page,10);Number.isNaN(nextpage)||loadVideos({page:nextpage})}const removeFilterBtn=target.closest(".videolesson-remove-filter");if(removeFilterBtn){event.preventDefault(),event.stopPropagation();const badge=removeFilterBtn.closest(".videolesson-filter-badge");if(badge){const filterType=badge.getAttribute("data-filter-type");"search"===filterType?(currentSearch="",updateHistory(!0),loadVideos({folderId:currentFolder,search:"",page:0,pushState:!0,replaceState:!1})):"folder"===filterType&&(currentFolder=0,updateHistory(!0),loadVideos({folderId:0,search:currentSearch,page:0,pushState:!0,replaceState:!1}))}return}target.closest(".videolesson-refresh-table")&&(event.preventDefault(),loadVideos({pushState:!1,replaceState:!0}));const assignBtn=target.closest(".videolesson-assign-folder");if(assignBtn){event.preventDefault();!async function(videoId,currentFolderValue){let videoTitle=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";try{const[title,selectLabel,uncategorizedLabel]=await Promise.all([(0,_str.get_string)("folder:assign","mod_videolesson"),(0,_str.get_string)("folder:select","mod_videolesson"),(0,_str.get_string)("folder:uncategorized","mod_videolesson")]),loadingBody=getLoadingBody("Loading folders..."),modal=await _modal_factory.default.create({type:_modal_factory.default.types.SAVE_CANCEL,title:title,body:loadingBody});modal.show();const tree=await(0,_folders.ensureFolderTreeData)(),currentFolderId=void 0===currentFolderValue||""===currentFolderValue||"null"===currentFolderValue?null:parseInt(currentFolderValue,10),options=[{value:"",label:uncategorizedLabel,selected:null===currentFolderId},...flattenFolderOptions(tree,currentFolderId)],body=await _templates.default.render("mod_videolesson/assign_folder_modal",{label:selectLabel,options:options,videotitle:videoTitle});modal.getRoot().find(".modal-body").html(body),modal.getRoot().on(_modal_events.default.save,(async()=>{const selected=modal.getRoot().find("#videolesson-assign-folder-select").val(),folderId=""===selected?null:parseInt(selected,10);await assignFolder(videoId,folderId),modal.destroy()})),modal.show()}catch(error){_notification.default.exception(error)}}(assignBtn.getAttribute("data-videolesson-id"),assignBtn.getAttribute("data-current-folder"),assignBtn.getAttribute("data-video-title")||"")}const deleteLink=target.closest(".videolesson-delete-link");if(deleteLink){console.log("deleteLink",deleteLink),event.preventDefault();const videoIdAttr=deleteLink.getAttribute("data-video-id")||deleteLink.dataset.videoId,videoName=deleteLink.getAttribute("data-video-name")||deleteLink.dataset.videoName||"";if(videoIdAttr){const videoId=parseInt(videoIdAttr,10);isNaN(videoId)||async function(videoId){let videoName=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";try{const[confirmTitle,confirmBody,cancelText,yesText]=await Promise.all([(0,_str.get_string)("confirmation","mod_videolesson"),(0,_str.get_string)("manage:video:delete:confirm","mod_videolesson").then((msg=>videoName?msg.replace("{$a}",videoName):msg.replace("{$a}","this video"))),(0,_str.get_string)("cancel"),(0,_str.get_string)("yes","moodle")]),modal=await _modal_factory.default.create({type:_modal_factory.default.types.SAVE_CANCEL,title:confirmTitle,body:confirmBody,buttons:{cancel:cancelText,save:yesText}});modal.getRoot().one(_modal_events.default.save,(function(e){e.preventDefault(),e.stopPropagation(),(async()=>{const loadingBody=getLoadingBody("Deleting video...");modal.getRoot().find(".modal-body").html(loadingBody),modal.getRoot().find('[data-action="save"]').prop("disabled",!0),modal.getRoot().find('[data-action="cancel"]').prop("disabled",!0);try{const response=await _ajax.default.call([{methodname:"mod_videolesson_bulk_delete_videos",args:{videoids:[videoId]}}])[0];if(modal.destroy(),response.success){const msg=await(0,_str.get_string)("success:delete","mod_videolesson");Toast.add(msg),await(0,_folders.loadFolderTree)(),await loadVideos({folderId:currentFolder,search:currentSearch,page:currentPage,pushState:!1,replaceState:!0})}else{const errorMsg=response.errors&&response.errors.length>0?response.errors.join(", "):await(0,_str.get_string)("bulk:error","mod_videolesson");Toast.add(errorMsg,{type:"error"})}}catch(error){modal.destroy(),_notification.default.exception(error)}})()})),modal.show()}catch(error){_notification.default.exception(error)}}(videoId,videoName)}}})),document.addEventListener("click",(async e=>{const subtitleBtn=e.target.closest(".videolesson-trigger-subtitle");if(subtitleBtn){e.preventDefault();const contenthash=subtitleBtn.getAttribute("data-contenthash")||subtitleBtn.dataset.contenthash;subtitleBtn.getAttribute("data-video-name")||subtitleBtn.dataset.videoName;contenthash&&await async function(contenthash){try{const[modalTitle,cancelText,submitText]=await Promise.all([(0,_str.get_string)("subtitle:modal:title","mod_videolesson"),(0,_str.get_string)("cancel"),(0,_str.get_string)("subtitle:modal:submit","mod_videolesson")]),loadingBody=getLoadingBody("Loading..."),modal=await _modal_factory.default.create({type:_modal_factory.default.types.SAVE_CANCEL,title:modalTitle,body:loadingBody,buttons:{cancel:cancelText,save:submitText}});modal.show();const languagesResponse=await _ajax.default.call([{methodname:"mod_videolesson_get_subtitle_languages",args:{contenthash:contenthash}}])[0],languages=languagesResponse.languages||[],existing=languagesResponse.existing||[],pending=languagesResponse.pending||[],processing=languagesResponse.processing||[],failed=languagesResponse.failed||[],maxSelectable=5-existing.filter((lang=>"original"!==("string"==typeof lang?lang:lang.code||""))).length-(pending.length+processing.length),canSelectMore=maxSelectable>0,selectableLanguages=canSelectMore?languages:[],body=await _templates.default.render("mod_videolesson/subtitle_modal",{languages:selectableLanguages,existing:existing,pending:pending,processing:processing,failed:failed,maxSelectable:maxSelectable,canSelectMore:canSelectMore});modal.getRoot().find(".modal-body").html(body),modal.getRoot().one(_modal_events.default.save,(function(e){e.preventDefault(),e.stopPropagation(),(async()=>{if(!canSelectMore){const remainingMsg=await(0,_str.get_string)("subtitle:modal:remaining","mod_videolesson").then((msg=>msg.replace("{$a}","0")));return void Toast.add(remainingMsg,{type:"error"})}const select=modal.getRoot().find("#subtitle-language-select"),selectedLanguages=Array.from(select[0].selectedOptions).map((opt=>opt.value));if(0===selectedLanguages.length)return void Toast.add(await(0,_str.get_string)("subtitle:select_language","mod_videolesson"),{type:"error"});const allPendingProcessing=[...pending.map((lang=>"string"==typeof lang?lang:lang.code||"")),...processing.map((lang=>"string"==typeof lang?lang:lang.code||""))];if(selectedLanguages.filter((lang=>allPendingProcessing.includes(lang))).length>0)return void Toast.add(await(0,_str.get_string)("error:subtitle:already_requested","mod_videolesson"),{type:"error"});const existingCodes=existing.map((lang=>"string"==typeof lang?lang:lang.code||""));if(selectedLanguages.filter((lang=>existingCodes.includes(lang))).length>0)return void Toast.add(await(0,_str.get_string)("error:subtitle:already_requested","mod_videolesson"),{type:"error"});if(selectedLanguages.length>maxSelectable){const remainingMsg=await(0,_str.get_string)("subtitle:modal:remaining","mod_videolesson").then((msg=>msg.replace("{$a}",maxSelectable.toString())));return void Toast.add(remainingMsg,{type:"error"})}const langString=selectedLanguages.join(","),loadingBody=getLoadingBody("Processing subtitle request...");modal.getRoot().find(".modal-body").html(loadingBody),modal.getRoot().find('[data-action="save"]').prop("disabled",!0),modal.getRoot().find('[data-action="cancel"]').prop("disabled",!0);try{const response=await _ajax.default.call([{methodname:"mod_videolesson_trigger_subtitle",args:{contenthash:contenthash,lang:langString}}])[0];modal.destroy();const[successMsg,errorMsg]=await Promise.all([(0,_str.get_string)("success:subtitle:triggered","mod_videolesson"),(0,_str.get_string)("error:subtitle:trigger_failed","mod_videolesson")]),resultMessage=response.success?response.message||successMsg:response.message||errorMsg,resultType=response.success?"success":"error";Toast.add(resultMessage,{type:resultType})}catch(error){modal.destroy(),_notification.default.exception(error)}})()})),modal.show()}catch(error){_notification.default.exception(error)}}(contenthash)}})),window.addEventListener("popstate",(e=>{const state=e.state;if(state){const folderId=folderParamToId(state.folder);loadVideos({folderId:folderId,search:state.search||"",page:state.page||0,pushState:!1,replaceState:!0}),highlightFolder(folderId)}else{const url=new URL(window.location.href),folderParam=url.searchParams.get("folder")||url.searchParams.get("folderid")||"all",search=url.searchParams.get("search")||"",page=parseInt(url.searchParams.get("vpage")||"0",10);loadVideos({folderId:folderParamToId(folderParam),search:search,page:page,pushState:!1,replaceState:!0}),highlightFolder(folderParamToId(folderParam))}})),tableContainer&&loadVideos({folderId:currentFolder,search:currentSearch,page:currentPage,pushState:!1,replaceState:!0})}}));

//# sourceMappingURL=manage.min.js.map