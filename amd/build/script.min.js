define("mod_videolesson/script",["exports","core/templates","core/ajax","core/modal_factory","core/modal_events","core/str","mod_videolesson/debug","mod_videolesson/constants"],(function(_exports,_templates,_ajax,_modal_factory,_modal_events,_str,Debug,_constants){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Script utilities for videolesson plugin
   *
   * @module     mod_videolesson/script
   * @copyright  2022-2026 BitKea Technologies LLP
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.secondsToMinutesAndSeconds=_exports.initializePlayer=_exports.getUrlParameter=_exports.getSubtitles=_exports.addSubtitleTracks=void 0,_templates=_interopRequireDefault(_templates),_ajax=_interopRequireDefault(_ajax),_modal_factory=_interopRequireDefault(_modal_factory),_modal_events=_interopRequireDefault(_modal_events),Debug=function(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}newObj.default=obj,cache&&cache.set(obj,newObj);return newObj}(Debug);_exports.initializePlayer=params=>new Promise(((resolve,reject)=>{let videoPlyr,isSeekBlocked=!1;const playerDefaultOptions={listeners:{seek:function(e){if(params.disableseek&&params.student&&params.video){var _params$video,_params$video$dataset;const current_time=videoPlyr.currentTime,newTime=((plyr,input)=>{if("object"!=typeof input||"input"!==input.type&&"change"!==input.type)return Number(input);{const max=input.target.max;return 0!==max&&max?input.target.value/max*plyr.duration:0}})(videoPlyr,e),maxwatched=parseFloat((null===(_params$video=params.video)||void 0===_params$video||null===(_params$video$dataset=_params$video.dataset)||void 0===_params$video$dataset?void 0:_params$video$dataset.maxwatched)||0);let shouldBlockSeek=!1;if(params.allowrewind?parseFloat(newTime)>maxwatched&&(shouldBlockSeek=!0):parseFloat(newTime)!==current_time&&(shouldBlockSeek=!0),shouldBlockSeek)return e.preventDefault(),videoPlyr.pause(),isSeekBlocked||(isSeekBlocked=!0,(async()=>{const modal=await _modal_factory.default.create({title:(0,_str.get_string)("player:seeking:disabled:header","mod_videolesson"),body:(0,_str.get_string)("player:seeking:disabled:description","mod_videolesson"),type:_modal_factory.default.types.CANCEL,buttons:{cancel:(0,_str.get_string)("gotit","mod_videolesson")}});modal.getRoot().find('[data-action="cancel"]').removeClass("btn-secondary").addClass("btn-primary"),new Promise((resolve=>{modal.getRoot().on(_modal_events.default.cancel,(()=>{resolve(!1),modal.hide()})),modal.getRoot().on(_modal_events.default.hidden,(()=>{modal.destroy()})),modal.show()}))})(),setTimeout((()=>{isSeekBlocked=!1}),_constants.SEEK_BLOCK_TIMEOUT)),videoPlyr.currentTime=current_time,!1}}},captions:{active:!0,update:!0,language:"en"},settings:[],controls:[]},settingControls=["play","progress","current-time","mute","volume","captions","settings","fullscreen",...params.pip?["pip"]:[]],settingOptions=["captions","quality","loop",...params.speed?["speed"]:[]];if(playerDefaultOptions.settings=settingOptions,playerDefaultOptions.controls=settingControls,"embed"!==params.provider&&"external"!==params.provider||"youtube"!==params.externaltype||(Debug.log("Configuring YouTube embed player",{provider:params.provider,externaltype:params.externaltype}),playerDefaultOptions.youtube={noCookie:!0,rel:0,modestbranding:1}),"embed"!==params.provider&&"external"!==params.provider||"vimeo"!==params.externaltype||(Debug.log("Configuring Vimeo embed player",{provider:params.provider,externaltype:params.externaltype}),playerDefaultOptions.vimeo={dnt:!0}),params.ishls&&params.video){var _params$video2,_params$video2$datase;const source=null===(_params$video2=params.video)||void 0===_params$video2||null===(_params$video2$datase=_params$video2.dataset)||void 0===_params$video2$datase?void 0:_params$video2$datase.source;if(!source)return void reject(new Error("HLS source not found"));const hls=new Hls;hls.loadSource(source);const hlsTimeout=setTimeout((()=>{const errorMessage="HLS initialization timed out.";Debug.error(errorMessage),displayErrorMessage(errorMessage,params.video),reject(new Error(errorMessage))}),_constants.HLS_INIT_TIMEOUT);hls.on(Hls.Events.MANIFEST_PARSED,(function(){clearTimeout(hlsTimeout);const availableQualities=hls.levels.map((l=>l.height));availableQualities.unshift(0),playerDefaultOptions.quality={default:0,options:availableQualities,forced:!0,onChange:e=>updateQuality(e)},playerDefaultOptions.i18n={qualityLabel:{0:"Auto"}},hls.on(Hls.Events.LEVEL_SWITCHED,(function(event,data){const span=document.querySelector(".plyr__menu__container [data-plyr='quality'][value='0'] span");span&&(hls.autoLevelEnabled?span.innerHTML="AUTO (".concat(hls.levels[data.level].height,"p)"):span.innerHTML="AUTO")})),videoPlyr=new Plyr(params.video,playerDefaultOptions),"undefined"!=typeof window&&Debug.isDebugEnabled()&&(window.videolesson=window.videolesson||{},window.videolesson.player=videoPlyr),resolve(videoPlyr)})),hls.attachMedia(params.video),"undefined"!=typeof window&&Debug.isDebugEnabled()&&(window.videolesson=window.videolesson||{},window.videolesson.hls=hls),hls.on(Hls.Events.ERROR,(function(event,data){clearTimeout(hlsTimeout);let errorMessage="An unknown error occurred.";switch(data.type){case Hls.ErrorTypes.NETWORK_ERROR:errorMessage="A network error occurred while fetching the media.";break;case Hls.ErrorTypes.MEDIA_ERROR:errorMessage="An error occurred while loading the media.";break;case Hls.ErrorTypes.OTHER_ERROR:errorMessage="An unexpected error occurred."}Debug.error("HLS Error",{message:errorMessage,data:data}),displayErrorMessage(errorMessage,params.video),reject(new Error(errorMessage))}))}else{if(!("embed"!==params.provider&&"external"!==params.provider||"youtube"!==params.externaltype&&"vimeo"!==params.externaltype)){(()=>new Promise((resolveAPI=>{if("youtube"===params.externaltype)if(window.YT&&window.YT.Player)Debug.log("YouTube API ready"),resolveAPI();else{Debug.log("Waiting for YouTube API...");const existingHandler=window.onYouTubeIframeAPIReady;window.onYouTubeIframeAPIReady=()=>{existingHandler&&"function"==typeof existingHandler&&existingHandler(),Debug.log("YouTube API ready (callback)"),resolveAPI()};const timeoutId=setTimeout((()=>{Debug.log("YouTube API timeout, proceeding anyway"),resolveAPI()}),_constants.YOUTUBE_API_TIMEOUT);resolveAPI.timeoutId&&clearTimeout(resolveAPI.timeoutId),resolveAPI.timeoutId=timeoutId}else if("vimeo"===params.externaltype)if(window.Vimeo&&window.Vimeo.Player)Debug.log("Vimeo API ready"),resolveAPI();else{Debug.log("Waiting for Vimeo API...");let checkInterval=setInterval((()=>{window.Vimeo&&window.Vimeo.Player&&(clearInterval(checkInterval),checkInterval=null,Debug.log("Vimeo API ready"),resolveAPI())}),_constants.VIMEO_API_CHECK_INTERVAL);const timeoutId=setTimeout((()=>{checkInterval&&(clearInterval(checkInterval),checkInterval=null),Debug.log("Vimeo API timeout, proceeding anyway"),resolveAPI()}),_constants.VIMEO_API_TIMEOUT);resolveAPI.cleanup=()=>{checkInterval&&(clearInterval(checkInterval),checkInterval=null),clearTimeout(timeoutId)}}else resolveAPI()})))().then((()=>{try{var _params$video3,_params$video4,_params$video5,_videoPlyr$embed;Debug.log("Initializing Plyr player (embed)",{provider:params.provider,externaltype:params.externaltype,element:null===(_params$video3=params.video)||void 0===_params$video3?void 0:_params$video3.tagName,className:null===(_params$video4=params.video)||void 0===_params$video4?void 0:_params$video4.className,hasIframe:!(null===(_params$video5=params.video)||void 0===_params$video5||!_params$video5.querySelector("iframe"))}),videoPlyr=new Plyr(params.video,playerDefaultOptions),"undefined"!=typeof window&&Debug.isDebugEnabled()&&(window.videolesson=window.videolesson||{},window.videolesson.player=videoPlyr),Debug.log("Plyr instance created (embed)",{hasEmbed:!!videoPlyr.embed,embedProvider:null===(_videoPlyr$embed=videoPlyr.embed)||void 0===_videoPlyr$embed?void 0:_videoPlyr$embed.provider,duration:videoPlyr.duration}),resolve(videoPlyr)}catch(error){Debug.error("Error initializing embed player",error),reject(error)}}))}else try{var _params$video6,_params$video7,_params$video8,_videoPlyr$embed2;Debug.log("Initializing Plyr player (non-HLS)",{provider:params.provider,externaltype:params.externaltype,element:null===(_params$video6=params.video)||void 0===_params$video6?void 0:_params$video6.tagName,className:null===(_params$video7=params.video)||void 0===_params$video7?void 0:_params$video7.className,hasIframe:!(null===(_params$video8=params.video)||void 0===_params$video8||!_params$video8.querySelector("iframe"))}),videoPlyr=new Plyr(params.video,playerDefaultOptions),"undefined"!=typeof window&&Debug.isDebugEnabled()&&(window.videolesson=window.videolesson||{},window.videolesson.player=videoPlyr),Debug.log("Plyr instance created",{hasEmbed:!!videoPlyr.embed,embedProvider:null===(_videoPlyr$embed2=videoPlyr.embed)||void 0===_videoPlyr$embed2?void 0:_videoPlyr$embed2.provider,duration:videoPlyr.duration}),resolve(videoPlyr)}catch(error){Debug.error("Error initializing non-HLS player",error),reject(error)}}}));const displayErrorMessage=async function(message){var _video$dataset;let playerContainer,video=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(!video)return void Debug.error("Video element not provided for error display");const hash=null==video||null===(_video$dataset=video.dataset)||void 0===_video$dataset?void 0:_video$dataset.hash;if(playerContainer=hash?document.querySelector("#player-placeholder-".concat(hash)):document.querySelector("#player-placeholder"),playerContainer)try{playerContainer.innerHTML=await _templates.default.render("mod_videolesson/error_player",{message:message});const retryButton=playerContainer.querySelector(".retry-button");retryButton?retryButton.addEventListener("click",(()=>{window.location.reload()})):Debug.warn("Retry button not found inside player container")}catch(error){Debug.error("Error rendering error message template",error)}else Debug.error("Player container not found")},updateQuality=newQuality=>{var _window$videolesson;const hls=null===(_window$videolesson=window.videolesson)||void 0===_window$videolesson?void 0:_window$videolesson.hls;if(hls)try{0===newQuality?hls.currentLevel=-1:hls.levels.forEach(((level,levelIndex)=>{level.height===newQuality&&(hls.currentLevel=levelIndex)}))}catch(error){Debug.error("Error updating quality",error)}else Debug.warn("HLS instance not available for quality update")};_exports.secondsToMinutesAndSeconds=seconds=>{const minutes=Math.floor(seconds/60),remainingSeconds=seconds%60;return String(minutes).padStart(2,"0")+":"+String(remainingSeconds).padStart(2,"0")};_exports.getUrlParameter=name=>{const escapedName=name.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]"),results=new RegExp("[\\?&]"+escapedName+"=([^&#]*)").exec(window.location.search);return null===results?"":decodeURIComponent(results[1].replace(/\+/g," "))};_exports.getSubtitles=contenthash=>new Promise(((resolve,reject)=>{_ajax.default.call([{methodname:"mod_videolesson_getsubtitles",args:{contenthash:contenthash},done:function(response){resolve(response)},fail:function(error){reject(error)}}])}));_exports.addSubtitleTracks=(video,tracks)=>{tracks.forEach((track=>{const trackEl=document.createElement("track");trackEl.kind="subtitles",trackEl.label=track.language,trackEl.srclang=track.code,trackEl.src=track.url,track.default&&(trackEl.default=!0),video.appendChild(trackEl)}))}}));

//# sourceMappingURL=script.min.js.map